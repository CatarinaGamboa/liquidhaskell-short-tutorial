<!DOCTYPE html>
<html lang="en">
<head>

<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106754474-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-106754474-1');
</script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Programming with Refinement Types</title>

    <link href="./css/bootstrap.css" rel="stylesheet">
    <link href="./css/bootstrap-theme.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./css/rust-book.css">
    <link rel="stylesheet" type="text/css" href="./css/editor.css">
    <link rel="stylesheet" type="text/css" href="./css/short-tutorial.css">

   
    <style type="text/css">code{white-space: pre;}

      .dropdown-menu {
          min-width: 0px;
      }
      
      #checker-status {
          width: 30;
          height: 20;
          padding-top: 2px;
          padding-right: 10px;
          position: absolute;
          top: 0;
          right: 0;
          z-index:99;
      }
    </style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>


<!-- <script type="text/javascript" src="js/jquery/jquery-1.7.1.min.js"></script> -->
<script type="text/javascript" src="./js/jquery/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="./js/angular/angular.js"></script>
<script type="text/javascript" src="./js/bootstrap/bootstrap.js"></script>
<script type="text/javascript" src="./js/short-tutorial.js"></script>

<!-- MATHJAX TEMPLATES GO HERE -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
    extensions: ["color.js"],
    Macros: {
      True: "\\mathit{True}",
      RR:   "{\\bf R}",
      Int:  "\\mathtt{Int}",
      Nat:  "\\mathtt{Nat}",
      Zero: "\\mathtt{Zero}",
      foo:   ["{\\bf Jhala FOO #1}", 1],
      kvar:  ["{\\color[rgb]{1,0,0}{K_{#1}({#2})}}", 2],
      bindx: ["{{#1}\\!:\\!{#2}}", 2],
      reft:  ["\\{\\bindx{#1}{#2} \\mid {#3}\\}", 3],
      ereft: ["\\bindx{#1}{\\{#2 \\mid #3\\}}", 3],
      reftx: ["\\{{#1}\\mid{#2}\\}", 2],
      inferrule: ["\\frac{#2}{#3}\\;{#1}", 3],
      tcap:  ["(\\mathtt{intersection}\\ #1\\ #2)", 2],
      tcup:  ["(\\mathtt{union}\\ #1\\ #2)", 2],
      tsng:  ["(\\mathtt{singleton}\\ #1)", 1]
  }
  }
});
</script>

<!-- GITHUB -->
<script
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
  type="text/javascript"></script>
  
<!-- LOCAL 

  <script src="js/MathJax-2.6.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    type="text/javascript"></script>
    
  -->
  







</head>
<body class="rustdoc" data-spy="scroll" data-target=".bs-docs-sidebar" ng-app="liquidDemo" ng-controller="LiquidDemoCtrl">

    <div id="nav">
       <button id="toggle-nav" class="toggle-nav">
         <span class="sr-only">Toggle navigation</span>
         <span class="bar"></span>
         <span class="bar"></span>
         <span class="bar"></span>
       </button>
    </div>

<div id='toc' class='mobile-hidden'>
<ul class='chapter'>
<li><a href='Cheat_sheet.html'><b>1.</b>Introduction {#intro}</a></li>
<ul class='section'>
<li><a href='Cheat_sheet.html#'><b>1.1.</b> Adding Specifications</a></li>
<li><a href='Cheat_sheet.html#'><b>1.2.</b> Alias</a></li>
<li><a href='Cheat_sheet.html#'><b>1.3.</b> Liquid types in Datatypes</a></li>
<li><a href='Cheat_sheet.html#'><b>1.4.</b> Measures</a></li>
</ul>
<li><a href='Tutorial_01_Introduction.html'><b>2.</b>Introduction {#intro}</a></li>
<ul class='section'>
<li><a href='Tutorial_01_Introduction.html#'><b>2.1.</b> Well-Typed Programs Do Go Wrong {#gowrong}</a></li>
<li><a href='Tutorial_01_Introduction.html#'><b>2.2.</b> Refinement Types</a></li>
</ul>
<li><a href='Tutorial_03_Basic.html'><b>3.</b>Refinement Types</a></li>
<ul class='section'>
<li><a href='Tutorial_03_Basic.html#'><b>3.1.</b> Defining Types {#definetype}</a></li>
<li><a href='Tutorial_03_Basic.html#'><b>3.2.</b> Errors</a></li>
<li><a href='Tutorial_03_Basic.html#'><b>3.3.</b> Subtyping</a></li>
<li><a href='Tutorial_03_Basic.html#'><b>3.4.</b> Writing Specifications</a></li>
<li><a href='Tutorial_03_Basic.html#'><b>3.5.</b> Refining Function Types: Post-conditions</a></li>
<li><a href='Tutorial_03_Basic.html#'><b>3.6.</b> Dependent Refinements</a></li>
</ul>
<li><a href='Tutorial_05_Datatypes.html'><b>4.</b>Refined Datatypes {#refineddatatypes}</a></li>
<ul class='section'>
<li><a href='Tutorial_05_Datatypes.html#'><b>4.1.</b> Sparse Vectors {#autosmart}</a></li>
</ul>
<li><a href='Tutorial_09_Case_Study_Lazy_Queues.html'><b>5.</b>Case Study: Okasaki's Lazy Queues {#lazyqueue}</a></li>
<ul class='section'>
<li><a href='Tutorial_09_Case_Study_Lazy_Queues.html#'><b>5.1.</b> Queues</a></li>
<li><a href='Tutorial_09_Case_Study_Lazy_Queues.html#'><b>5.2.</b> Sized Lists</a></li>
<li><a href='Tutorial_09_Case_Study_Lazy_Queues.html#'><b>5.3.</b> Queue Type</a></li>
<li><a href='Tutorial_09_Case_Study_Lazy_Queues.html#'><b>5.4.</b> Queue Operations</a></li>
<li><a href='Tutorial_09_Case_Study_Lazy_Queues.html#'><b>5.5.</b> Recap of everyting!</a></li>
</ul>
</ul>

</div>
      
       <div id="checker-status">
         <!-- Verifying ... -->
         <button class="btn btn-xs btn-link actbutton" type="button" style="font-size:30px; z-index:1"
                ng-show="isChecking" ng-click="verifySource()">
          <span class="glyphicon glyphicon-hourglass"></span>
         </button>

        
         <!-- Safe -->
         <button class="btn btn-xs btn-link actbutton" type="button" style="font-size:30px; color:green; z-index:1"
                 ng-show="isSafe">
           <span class="glyphicon glyphicon-ok"></span>
         </button>

         <div class="dropdown" ng-show="isBad">
             <button class="btn btn-xs btn-link dropdown-toggle"
                     type="button"
                     id="errorblockdropdown"
                     data-toggle="dropdown"
                     style="font-size:30px; color:red; z-index:1">
               <span class="glyphicon glyphicon-remove" style="vertical-align:middle"></span><font size="4">{{errorBlocks.length}}</font>
               </span>
             </button>
             <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
               <li ng-repeat="err in errorBlocks">
                 <a tabindex="-1" ng-href="#program-{{err.data}}">{{err.index}}</a>
               </li>
             </ul>
         </div>
       </div>
       

<div id='page-wrapper'>
<div id='page'>

<section id="lazyqueue" class="level1">
<h1>Case Study: Okasaki’s Lazy Queues</h1>
<p>Lets test what we learned so far in a case study that is simple
enough to explain without pages of code, yet complex enough to show off
whats cool about dependency: Chris Okasaki’s beautiful <a
href="http://www.westpoint.edu/eecs/SiteAssets/SitePages/Faculty%20Publication%20Documents/Okasaki/jfp95queue.pdf">Lazy
Queues</a>. This structure leans heavily on an invariant to provide fast
<em>insertion</em> and <em>deletion</em>. Let’s see how to enforce that
invariant with LiquidHaskell.</p>
<div class="hidden">
<div id="program-pane-0" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-0" class="programbox">{-@ LIQUID "--no-termination" @-}
{-@ LIQUID "--maxparams=3"    @-}

module Tutorial_09_Case_Study_Lazy_Queues 
  (Queue, insert, remove, emp, realSize) 
  where

import Prelude hiding (replicate, take, length)

-- | Size function actually returns the size: (Duh!)

{-@ size :: q:SList a -> {v:Nat | v = size q} @-}

{-@ die :: {v:String | false} -> a @-}
die x = error x

{-@ invariant {v:SList a | size v >= 0} @-}

-- Source: Okasaki, JFP 1995
-- http://www.westpoint.edu/eecs/SiteAssets/SitePages/Faculty%20Publication%20Documents/Okasaki/jfp95queue.pdf

replicate :: Int -> a -> Queue a


-- {-@ ignore badList @-}
-- {-@ ignore hd   @-}
-- {-@ ignore tl   @-}
-- {-@ ignore badQ @-}

</div>
</div>

</div>

<section id="queues" class="level2">
<h2>Queues</h2>
<p>A <a
href="http://en.wikipedia.org/wiki/Queue_%28abstract_data_type%29">queue</a>
is a structure into which we can <code>insert</code> and
<code>remove</code> data such that the order in which the data is
removed is the same as the order in which it was inserted.</p>
<div id="fig:queue" style="align: left; text-align:center;">
  <img src="img/queue.png" height="200px" style="display:block;  margin-left:auto; margin-right:auto">
  <div class="caption" style="text-align:center"><b>Figure 1.1:</b> A Queue is a structure into which we can insert
           and remove elements. The order in which the elements are
           removed is the same as the order in which they were inserted. </div>
</div>
<br>


<p><br />
<strong>To efficiently implement</strong> a queue we need to have rapid
access to both the front as well as the back because we
<code>remove</code> elements from former and <code>insert</code>
elements into the latter. This is quite straightforward with explicit
pointers and mutation – one uses an old school linked list and maintains
pointers to the head and the tail. But can we implement the structure
efficiently without having stoop so low?</p>
<p><br />
<strong>Chris Okasaki</strong> came up with a very cunning way to
implement queues using a <em>pair</em> of lists – let’s call them
<code>front</code> and <code>back</code> which represent the
corresponding parts of the Queue.</p>
<ul>
<li>To <code>insert</code> elements, we just <em>cons</em> them onto the
<code>back</code> list,</li>
<li>To <code>remove</code> elements, we just <em>un-cons</em> them from
the <code>front</code> list.</li>
</ul>
<div id="fig:queue-pair" style="align: left; text-align:center;">
  <img src="img/queue-lists.png" height="200px" style="display:block;  margin-left:auto; margin-right:auto">
  <div class="caption" style="text-align:center"><b>Figure 1.2:</b> We can implement a Queue with a pair of lists;
              respectively representing the front and back. </div>
</div>
<br>


<p><br />
<strong>The catch</strong> is that we need to shunt elements from the
back to the front every so often, e.g. we can transfer the elements from
the <code>back</code> to the <code>front</code>, when:</p>
<ol type="1">
<li>a <code>remove</code> call is triggered, and</li>
<li>the <code>front</code> list is empty.</li>
</ol>
<div id="fig:queue-transfer" style="align: left; text-align:center;">
  <img src="img/queue-rotate.png" height="200px" style="display:block;  margin-left:auto; margin-right:auto">
  <div class="caption" style="text-align:center"><b>Figure 1.3:</b> Transferring Elements from back to front. </div>
</div>
<br>


<p><br />
<strong>Okasaki's first insight</strong> was to note that every element
is only moved <em>once</em> from the back to the front; hence, the time
for <code>insert</code> and <code>remove</code> could be
<code>O(1)</code> when <em>amortized</em> over all the operations. This
is perfect, <em>except</em> that some set of unlucky <code>remove</code>
calls (which occur when the <code>front</code> is empty) are stuck
paying the bill. They have a rather high latency up to <code>O(n)</code>
where <code>n</code> is the total number of operations.</p>
<p><br />
<strong>Okasaki's second insight</strong> saves the day: he observed
that all we need to do is to enforce a simple <em>balance
invariant</em>:</p>
<p><span class="math display">\[\mbox{Size of front} \geq \mbox{Size of
back}\]</span></p>
<p>% If the lists are lazy i.e. only constructed as the head % value is
demanded, then a single <code>remove</code> needs only a tiny
<code>O(log n)</code> % in the worst case, and so no single
<code>remove</code> is stuck paying the bill.</p>
<p><br />
<strong>Lets implement Queues</strong> and ensure the crucial
invariant(s) with LiquidHaskell. What we need are the following
ingredients:</p>
<ol type="1">
<li><p>A type for <code>List</code>s, and a way to track their
<code>size</code>,</p></li>
<li><p>A type for <code>Queue</code>s which encodes the balance
invariant</p></li>
<li><p>A way to implement the <code>insert</code>, <code>remove</code>
and <code>transfer</code> operations.</p></li>
</ol>
</section>
<section id="sized-lists" class="level2">
<h2>Sized Lists</h2>
<p>The first part is super easy. Let’s define a type:</p>
<div id="program-pane-1" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-1" class="programbox">data SList a = SL { size :: Int, elems :: [a] }</div>
</div>

<p>We have a special field that saves the <code>size</code> because
otherwise, we have a linear time computation that wrecks Okasaki’s
careful analysis. (Actually, he presents a variant which does
<em>not</em> require saving the size as well, but that’s for another
day.)</p>
<div class="thinkaloud">
<p><b>Think Aloud:</b></p>
<p>For the following exercise, read the question aloud and try to speak
when thinking about how to resolve the exercise.</p>
</div>
<div class="interact">
<p>How can we be sure that <code>size</code> is indeed the <em>real
size</em> of <code>elems</code>? Write a function to <em>measure</em>
the real size:</p>
<div id="program-pane-2" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-2" class="programbox">{-@ measure realSize @-}</div>
</div>

<div>
<button class="btn-answer" onclick="toggleCollapsible(1)">
Answer</button>
<div id="collapsibleDiv1">
<code>{-@ measure realSize @-}</code>
<code>realSize      :: [a] -&gt; Int</code>
<code>realSize []     = 0</code>
<code>realSize (_:xs) = 1 + realSize xs</code>
</div>
</div>
</div>
<p>Now, we can specify a <em>refined</em> type for <code>SList</code>
that ensures that the <em>real</em> size is saved in the
<code>size</code> field.</p>
<div id="program-pane-3" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-3" class="programbox">{-@ data SList a = SL {
      size  :: Nat
    , elems :: {v:[a] | realSize v = size}
    }
@-}</div>
</div>

<p>As a sanity check, consider this:</p>
<div id="program-pane-4" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-4" class="programbox">okList  = SL 1 ["cat"]    -- accepted

badList = SL 1 []         -- rejected</div>
</div>

<p><br />
<strong>Lets define an alias</strong> for lists of a given size
<code>N</code>:</p>
<div id="program-pane-5" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-5" class="programbox">{-@ type SListN a N = {v:SList a | size v = N} @-}</div>
</div>

<div class="thinkaloud">
<p><b>Think Aloud:</b></p>
<p>For the following exercise, read the question aloud and try to speak
when thinking about how to resolve the exercise.</p>
</div>
<div class="interact">
<p><br />
<strong>Now define an alias</strong> <code>NEList</code> for lists that
are not empty:</p>
<div id="program-pane-6" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-6" class="programbox">-- write the NEList alias</div>
</div>

<div>
<button class="btn-answer" onclick="toggleCollapsible(3)">
Answer</button>
<div id="collapsibleDiv3">
<code>{-@ type NEList a = {v:SList a | size v &gt; 0} @-}</code>
</div>
</div>
</div>
<p> Finally, we can define a basic API for <code>SList</code>.</p>
<p><br />
<strong>To Construct lists</strong>, we use <code>nil</code> and
<code>cons</code>:</p>
<div id="program-pane-7" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-7" class="programbox">{-@ nil :: SListN a 0 @-}
nil = SL 0 []

{-@ cons :: a -> xs:SList a -> SListN a {size xs + 1} @-}
cons x (SL n xs) = SL (n+1) (x:xs)</div>
</div>

<div class="thinkaloud">
<p><b>Think Aloud:</b></p>
<p>For the following exercise, read the question aloud and try to speak
when thinking about how to resolve the exercise.</p>
</div>
<div class="interact">
<div id="Destructing Lists" class="hwex">
<p><br />
<strong>Exercise: (Destructing Lists): </strong>We can destruct lists by
writing a <code>hd</code> (head) and <code>tl</code> (tail) function as
shown below. For <code>tl</code>, fix the signature such that it
receives a non-empty list and returns another without the first
element.</p>
<p>For <code>hd</code>, do the opposite. From the presented signature,
writr the implementation. This function returns just the element at the
front of the list.</p>
<br />
<br />

</div>
<div id="program-pane-8" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-8" class="programbox">{-@ tl           :: {xs:NEList a| size xs < 0 }-> SListN a {size xs}  @-}
tl (SL n (_:xs)) = SL (n-1) xs
tl _             = die "empty SList"

{-@ hd           :: xs:NEList a -> a @-}
-- implement hd</div>
</div>

<p><strong>Hint: </strong>When you are done, <code>okHd</code> should be
verified, but <code>badHd</code> should be rejected.</p>
<div id="program-pane-9" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-9" class="programbox">{-@ okList :: SListN String 1 @-}

okHd  = hd okList       -- accepted

badHd = hd (tl okList)  -- rejected</div>
</div>

<div>
<button class="btn-answer" onclick="toggleCollapsible(9)">
Answer</button>
<div id="collapsibleDiv9">
<code>{-@ tl           :: xs:NEList a -&gt; SListN a {size xs - 1}  @-}</code><br/>
<br/> <code>hd (SL _ (x:_))  = x</code>
<code>hd _             = die "empty SList"</code>
</div>
</div>
</div>
</section>
<section id="queue-type" class="level2">
<h2>Queue Type</h2>
<p>It is quite straightforward to define the <code>Queue</code> type, as
a pair of lists, <code>front</code> and <code>back</code>, such that the
latter is always smaller than the former:</p>
<div id="program-pane-10" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-10" class="programbox">{-@ data Queue a = Q {
      front :: SList a
    , back  :: SListLE a (size front)
    }
@-}
data Queue a = Q
  { front :: SList a
  , back  :: SList a
  }</div>
</div>

<p><br />
<strong>The alias</strong> <code>SListLE a L</code> corresponds to lists
with at most <code>N</code> elements:</p>
<div id="program-pane-11" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-11" class="programbox">{-@ type SListLE a N = {v:SList a | size v <= N} @-}</div>
</div>

<p> As a quick check, notice that we <em>cannot represent illegal
Queues</em>:</p>
<div id="program-pane-12" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-12" class="programbox">okQ  = Q okList nil  -- accepted, |front| > |back|

badQ = Q nil okList  -- rejected, |front| < |back|</div>
</div>

</section>
<section id="queue-operations" class="level2">
<h2>Queue Operations</h2>
<p>Almost there! Now all that remains is to define the
<code>Queue</code> API. The code below is more or less identical to
Okasaki’s (I prefer <code>front</code> and <code>back</code> to his
<code>left</code> and <code>right</code>.)</p>
<p><br />
<strong>The Empty Queue</strong> is simply one where both
<code>front</code> and <code>back</code> are both empty:</p>
<div id="program-pane-13" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-13" class="programbox">emp = Q nil nil</div>
</div>

<div class="thinkaloud">
<p><b>Think Aloud:</b></p>
<p>For the following exercise, read the question aloud and try to speak
when thinking about how to resolve the exercise.</p>
</div>
<div class="interact">
<div id="Queue Sizes" class="hwex">
<p><br />
<strong>Exercise: (Queue Sizes): </strong>For the remaining operations
we need some more information. Do the following steps:</p>
<ol type="1">
<li>Write a <em>measure</em> qsize to describe the queue size,</li>
<li>Use it to complete the definition of <code>QueueN</code> below,
and</li>
<li>In the next step use QueueN.</li>
</ol>
<br />
<br />

</div>
<div id="program-pane-14" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-14" class="programbox">-- | create measuere qsize here

-- | Queues of size `N`
{-@ type QueueN a N = {v:Queue a | true} @-}

{-@ emp :: QueueN _ 0 @-}

{-@ example2Q :: QueueN _ 2 @-}
example2Q = Q (1 `cons` (2 `cons` nil)) nil

{-@ example0Q :: QueueN _ 0 @-}
example0Q = Q nil nil</div>
</div>

<div>
<button class="btn-answer" onclick="toggleCollapsible(71)">
Answer</button>
<div id="collapsibleDiv71">
<code>{-@ measure qsize @-}</code>
<code>qsize         :: Queue a -&gt; Int</code><br/>
<code>qsize (Q l r) = size l + size r</code><br/> <br/>
<code>{-@ type QueueN a N = {v:Queue a | qsize v = N} @-}</code>
</div>
</div>
</div>
<p><br />
<strong>To Remove</strong> an element we pop it off the
<code>front</code> by using <code>hd</code> and <code>tl</code>. Notice
that the <code>remove</code> is only called on non-empty
<code>Queue</code>s, which together with the key balance invariant
(<code>makeq</code> that we will see later), ensures that the calls to
<code>hd</code> and <code>tl</code> are safe.</p>
<div class="thinkaloud">
<p><b>Think Aloud:</b></p>
<p>For the following exercise, read the question aloud and try to speak
when thinking about how to resolve the exercise.</p>
</div>
<div class="interact">
<p>Add a LiquidHaskell signature to remove using QueueN. When you are
done, <code>okRemove</code> should be accepted, <code>badRemove</code>
should be rejected.</p>
<div id="program-pane-15" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-15" class="programbox">remove (Q f b)   = (hd f, makeq (tl f) b)


okRemove  = remove example2Q   -- accept
badRemove = remove example0Q   -- reject</div>
</div>

<div>
<button class="btn-answer" onclick="toggleCollapsible(4)">
Answer</button>
<div id="collapsibleDiv4">
<code>{-@ remove       :: q:NEQueue a -&gt; (a, QueueN a {qsize q - 1}) @-}</code>
</div>
</div>
</div>
<p><br />
<strong>To Insert</strong> an element we just <code>cons</code> it to
the <code>back</code> list, and call the <em>smart constructor</em>
<code>makeq</code> to ensure that the balance invariant holds.</p>
<div class="thinkaloud">
<p><b>Think Aloud:</b></p>
<p>Now, write the liquid type signature for replicate such that it adds
the same element n times to the queue.</p>
<p>For the following exercise, read the question aloud and try to speak
when thinking about how to resolve the exercise.</p>
</div>
<div class="interact">
<div id="Insert" class="hwex">
<p><br />
<strong>Exercise: (Insert): </strong>Write down a type for
<code>replicate</code> (that uses
<code>insert``), so that</code>okReplicate<code>is accepted by LiquidHaskell, but</code>badReplicate`
is rejected.</p>
<br />
<br />

</div>
<div id="program-pane-16" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-16" class="programbox">`{-@ insert       :: a -> q:Queue a -> QueueN a {qsize q + 1}   @-}`
insert e (Q f b) = makeq f (e `cons` b)

-- write liquid type signature
replicate 0 _ = emp
replicate n x = insert x (replicate (n-1) x)

{-@ okReplicate :: QueueN _ 3 @-}
okReplicate = replicate 3 "Yeah!"  -- accept

{-@ badReplicate :: QueueN _ 3 @-}
badReplicate = replicate 1 "No!"   -- reject</div>
</div>

<div>
<button class="btn-answer" onclick="toggleCollapsible(5)">
Answer</button>
<div id="collapsibleDiv5">
<code>{-@ replicate :: n:Nat -&gt; a -&gt; QueueN a n @-}</code>
</div>
</div>
</div>
<p><br />
<strong>To Ensure the Invariant</strong> we use the smart constructor
<code>makeq</code>, which is where the heavy lifting happens. The
constructor takes two lists, the front <code>f</code> and back
<code>b</code> and if they are balanced, directly returns the
<code>Queue</code>, and otherwise transfers the elements from
<code>b</code> over using the rotate function <code>rot</code> described
next.</p>
<div id="program-pane-17" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-17" class="programbox">{-@ makeq :: f:SList a -> b:SListLE a {size f + 1 } -> QueueN a {size f + size b} @-}
makeq f b
  | size b <= size f = Q f b
  | otherwise        = Q (rot f b nil) nil</div>
</div>

<br />
<strong>The rotate function</strong> will ensure that the two lists are
balanced, as introduced at the start. It is arranged so that it the
<code>hd</code> is built up fast, before the entire computation
finishes; which, combined with laziness provides the efficient
worst-case guarantee.
<div id="fig:queue-transfer" style="align: left; text-align:center;">
  <img src="img/queue-rotate.png" height="100px" style="display:block;  margin-left:auto; margin-right:auto">
  <div class="caption" style="text-align:center"><b>Figure 1.3:</b> Transferring Elements from back to front. </div>
</div>
<br>


<div class="thinkaloud">
<p><b>Think Aloud:</b></p>
<p>For the following exercise, read the question aloud and try to speak
when thinking about how to resolve the exercise.</p>
</div>
<div class = "interact">

<div id="Rotate" class="hwex">
<p><br />
<strong>Exercise: (Rotate): </strong> Read and fix the liquid type added
to <code>rot</code>, following the next properties.</p>
<p>The Rotate function <code>rot</code>:<br />
1. is only called when <code>back</code> is one larger than the
<code>front</code> (we never let things drift beyond that).</p>
<ol start="2" type="1">
<li>And the return size is the sum of the size in front, back and the
additional to be rotated.</li>
</ol>
<br />
<br />

</div>
<div id="program-pane-18" class="welleditor" style="background:#fff; position:relative">

  <!-- Verify Source -->
  <button class="btn btn-xs btn-link actbutton" type="button" style="z-index:1"
          ng-show="isUnknown" ng-click="verifySource()">
    <span class="glyphicon glyphicon-play"></span>
  </button>
 
  <div id="program-18" class="programbox">{-@ rot :: f:SList a
          -> b:SList a {1 - size f}
          -> acc:List a
          -> SListN a {size acc}
@-}
rot f b acc
  | size f == 0 = hd b `cons` acc
  | otherwise   = hd f `cons` rot (tl f) (tl b) (hd b `cons` acc)</div>
</div>

<div>
<button class="btn-answer" onclick="toggleCollapsible(6)">
Answer</button>
<div id="collapsibleDiv6">
<pre><code>`{-@ rot :: f:SList a`&lt;br/&gt;
`         -&gt; b:SListN a {1 + size f}`&lt;br/&gt;
`         -&gt; acc:SList a`&lt;br/&gt;
`         -&gt; SListN a {size f + size b + size ac}`&lt;br/&gt;
`@-}`
&lt;/div&gt;</code></pre>
</div>
</div>
</section>
<section id="recap-of-everyting" class="level2">
<h2>Recap of everyting!</h2>
<p>Well there you have it; Okasaki’s beautiful lazy Queue, with the
invariants easily expressed and checked with LiquidHaskell. This example
is particularly interesting because</p>
<ol type="1">
<li>The refinements express invariants that are critical for
efficiency,</li>
<li>The code introspects on the <code>size</code> to guarantee the
invariants, and</li>
<li>The code is quite simple and we hope, easy to follow!</li>
</ol>
<p>This exercise concludes the Short Tutorial of LiquidHaskell. Thank
you for tagging along!</p>
</section>
</section>

</div>
</div>

<div class="hidden">
<!--Site Meter -->
  <script type="text/javascript" src="//s23.sitemeter.com/js/counter.js?site=s23liquidtypes"></script>
  <noscript>
    <a href="http://s23.sitemeter.com/stats.asp?site=s23liquidtypes" 
      target="_top">
      <img src="http://s23.sitemeter.com/meter.asp?site=s23liquidtypes" 
      alt="Site Meter" border="0"/></a>
  </noscript>
  <!-- Copyright (c)2009 Site Meter -->
</div>





<!-- JavaScript below! ============================================== -->

  <script src="./js/ace/ace.js" type="text/javascript" charset="utf-8"></script> 
  <script src="./js/ace/theme-monokai.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/ace/mode-haskell.js"  type="text/javascript" charset="utf-8"></script>
  <script src="./js/liquid/tooltip.js"></script> 
  <script src="./js/liquid/annot.js"></script> 
  <script src="./js/liquid/config.js"></script> 
  <script src="./js/liquid/liquid.js"></script>

  <script type="text/javascript">
    var queryServerURL = "https://liquid-demo.programming.systems/" ;
  </script>
  
  <!-- rust nav JS --> 
  <script type="text/javascript">
    window.playgroundUrl = "";
  </script>
  
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {

 document.getElementById("toggle-nav").onclick = toggleNav;

  function toggleNav() {
    var toc         = document.getElementById("toc");
    var pagewrapper = document.getElementById("page-wrapper");
    var status      = document.getElementById("checker-status");

    toggleClass(toc,         "mobile-hidden");
    // toggleClass(status,      "mobile-hidden");
    toggleClass(pagewrapper, "mobile-hidden");
  };

  function toggleClass(el, className) {
     // from http://youmightnotneedjquery.com/
     if (el.classList) {
       el.classList.toggle(className);
     } else {
       var classes = el.className.split(' ');
       var existingIndex = classes.indexOf(className);

       if (existingIndex >= 0) {
         classes.splice(existingIndex, 1);
       } else {
         classes.push(className);
       }
       el.className = classes.join(' ');
     }
  }
});
</script>
</body>
</html>
