<h1 id="case-study-pointers-without-overflows">Case Study: Pointers Without Overflows</h1>

<p>A large part of the allure of Haskell is its elegant, high-level ADTs that ensure that programs won't be plagued by problems like the infamous <a href="heartbleed">SSL heartbleed bug</a>.  However, another part of Haskell's charm is that when you really really need to, you can drop down to low-level pointer twiddling to squeeze the most performance out of your machine. But of course, that opens the door to the heartbleeds.</p>
<p>Wouldn't it be nice to have have our cake and eat it too? That is wouldn't it be great if we could twiddle pointers at a low-level and still get the nice safety assurances of high-level types? In this case study, lets see how LiquidHaskell lets us do exactly that.</p>
<h2 id="heartbleeds-in-haskell">HeartBleeds in Haskell</h2>
<p> like Haskell are ultimately built upon the foundation of <code>C</code>. Thus, implementation errors could open up unpleasant vulnerabilities that could easily slither past the type system and even code inspection.</p>
<p> As a concrete example, lets look at a a function that uses the <code>ByteString</code> library to truncate strings:</p>
<pre><span class=hs-linenum>55: </span><span class='hs-definition'>chop</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<span class=hs-linenum>56: </span><span class='hs-definition'>chop</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s'</span>
<span class=hs-linenum>57: </span>  <span class='hs-keyword'>where</span> 
<span class=hs-linenum>58: </span>    <span class='hs-varid'>b</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>s</span>          <span class='hs-comment'>-- down to low-level</span>
<span class=hs-linenum>59: </span>    <span class='hs-varid'>b'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeTake</span> <span class='hs-varid'>n</span> <span class='hs-varid'>b</span>  <span class='hs-comment'>-- grab n chars</span>
<span class=hs-linenum>60: </span>    <span class='hs-varid'>s'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>unpack</span> <span class='hs-varid'>b'</span>       <span class='hs-comment'>-- up to high-level</span>
</pre>
<p>First, the function <code>pack</code>s the string into a low-level bytestring <code>b</code>, then it grabs the first <code>n</code> <code>Char</code>acters from <code>b</code> and translates them back into a high-level <code>String</code>. Lets see how the function works on a small test:</p>
<pre><span class=hs-linenum>69: </span><span class='hs-definition'>ghci</span><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ex</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Ranjit Loves Burritos"</span>
</pre>
<p>We get the right result when we <code>chop</code> a <em>valid</em> prefix:</p>
<pre><span class=hs-linenum>75: </span><span class='hs-definition'>ghci</span><span class='hs-varop'>&gt;</span> <span class='hs-varid'>chop</span> <span class='hs-varid'>ex</span> <span class='hs-num'>10</span>
<span class=hs-linenum>76: </span><span class='hs-str'>"Ranjit Lov"</span>
</pre>
<p>But, as illustrated in Figure~, the machine silently reveals (or more colorfully, <em>bleeds</em>) the contents of adjacent memory or if we use an <em>invalid</em> prefix:</p>
<pre><span class=hs-linenum>84: </span><span class='hs-definition'>ghci</span><span class='hs-varop'>&gt;</span> <span class='hs-varid'>heartBleed</span> <span class='hs-varid'>ex</span> <span class='hs-num'>30</span>
<span class=hs-linenum>85: </span><span class='hs-str'>"Ranjit Loves Burritos\NUL\201\&amp;1j\DC3\SOH\NUL"</span>
</pre>

<p> Now that we have stared the problem straight in the eye, look at how we can use LiquidHaskell to <em>prevent</em> the above at compile time. To this end, we decompose the overall system into a hierarchy of <em>levels</em> (i.e. <em>modules</em>). In this case, we have three levels:</p>
<ol style="list-style-type: decimal">
<li><strong>Machine</strong> level <code>Pointers</code></li>
<li><strong>Library</strong> level <code>ByteString</code></li>
<li><strong>User</strong> level <code>Application</code></li>
</ol>
<p>Now, our strategy, as before, is to develop an <em>refined API</em> for each level such that errors at <em>each</em> level are prevented by adhering to the types at <em>lower</em> levels.</p>
<p><strong>HEREHEREHERE</strong></p>
<h2 id="low-level-pointer-api">1. Low-level Pointer API</h2>
<p>Strategy: Specify and Verify Types for</p>
<p><br></p>
<ol style="list-style-type: decimal">
<li><strong>Low-level <code>Pointer</code> API</strong></li>
<li>Lib-level <code>ByteString</code> API</li>
<li>User-level <code>Application</code> API</li>
</ol>
<p><br></p>
<p>Errors at <em>each</em> level are prevented by types at <em>lower</em> levels</p>
<p></p>
<p><strong>Low-level Pointers</strong></p>
<pre><span class=hs-linenum>132: </span><span class='hs-keyword'>data</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span>         
</pre>
<p><br></p>
<div class="fragment">
<p><strong>Foreign Pointers</strong></p>
<pre><span class=hs-linenum>141: </span><span class='hs-keyword'>data</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span> 
</pre>
<p><br></p>
<code>ForeignPtr</code> wraps around <code>Ptr</code>; can be exported to/from C.
</div>
<p></p>
<div class="fragment">
<p><strong>Read</strong></p>
<pre><span class=hs-linenum>156: </span><span class='hs-definition'>peek</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>  
</pre>
</div>
<br>
<div class="fragment">
<p><strong>Write</strong></p>
<pre><span class=hs-linenum>165: </span><span class='hs-definition'>poke</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
</pre>
</div>
<p><br></p>
<div class="fragment">
<p><strong>Arithmetic</strong></p>
<pre><span class=hs-linenum>174: </span><span class='hs-definition'>plusPtr</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>b</span> 
</pre>
</div>
<p></p>
<div class="fragment">
<p><strong>Create</strong></p>
<pre><span class=hs-linenum>184: </span><span class='hs-definition'>malloc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span>
</pre>
</div>
<p><br></p>
<div class="fragment">
<p><strong>Unwrap and Use</strong></p>
<pre><span class=hs-linenum>194: </span><span class='hs-definition'>withForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span>     <span class='hs-comment'>-- pointer </span>
<span class=hs-linenum>195: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- action </span>
<span class=hs-linenum>196: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>b</span>             <span class='hs-comment'>-- result</span>
</pre>
</div>
<p></p>
<p><strong>Allocate a block and write 4 zeros into it</strong></p>
<div class="fragment">
<pre><span class=hs-linenum>207: </span><a class=annot href="#"><span class=annottext>forall a. (IO (ForeignPtr a))</span><span class='hs-definition'>zero4</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr a) | 0 &lt;= fplen VV}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr a) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>malloc</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (4  :  int)}</span><span class='hs-num'>4</span></a>
<span class=hs-linenum>208: </span>           <a class=annot href="#"><span class=annottext>x1:(ForeignPtr a)
-&gt; ({v : (Ptr a) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v} -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v} -&gt; (IO ()))
 -&gt; (IO ()))
-&gt; ({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr a) | fplen fp == plen VV &amp;&amp; zero &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>209: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>210: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>211: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>212: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>213: </span>           <a class=annot href="#"><span class=annottext>(ForeignPtr a) -&gt; (IO (ForeignPtr a))</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a>
<span class=hs-linenum>214: </span>        <span class='hs-keyword'>where</span>
<span class=hs-linenum>215: </span>           <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>zero</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-num'>0</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span>
</pre>
</div>
<p></p>
<p><strong>Allocate a block and write 4 zeros into it</strong></p>
<p>How to <em>prevent overflows</em> e.g. writing 5 or 50 zeros?</p>
<p><br></p>
<div class="fragment">
<p><strong>Step 1</strong></p>
<em>Refine pointers</em> with allocated size
</div>
<p><br></p>
<div class="fragment">
<p><strong>Step 2</strong></p>
<em>Track sizes</em> in pointer operations
</div>
<p>Refined API: Types</p>
<p><br></p>
<p><strong>1. Refine pointers with allocated size</strong></p>
<pre><span class=hs-linenum>249: </span><span class='hs-definition'>measure</span> <span class='hs-varid'>plen</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> 
<span class=hs-linenum>250: </span><span class='hs-definition'>measure</span> <span class='hs-varid'>fplen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> 
</pre>
<p><br></p>
<div class="fragment">
<p>Abbreviations for pointers of size <code>N</code></p>
<pre><span class=hs-linenum>259: </span><span class='hs-keyword'>type</span> <span class='hs-conid'>PtrN</span> <span class='hs-varid'>a</span> <span class='hs-conid'>N</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> 
<span class=hs-linenum>260: </span><span class='hs-keyword'>type</span> <span class='hs-conid'>ForeignPtrN</span> <span class='hs-varid'>a</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>fplen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> 
</pre>
</div>
<p>Refined API: Ops (1/3)</p>
<div class="fragment">
<p><strong>Create</strong></p>
<pre><span class=hs-linenum>271: </span><span class='hs-definition'>malloc</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ForeignPtrN</span> <span class='hs-varid'>a</span> <span class='hs-varid'>n</span>
</pre>
</div>
<p><br></p>
<div class="fragment">
<p><strong>Unwrap and Use</strong></p>
<pre><span class=hs-linenum>281: </span><span class='hs-definition'>withForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>fp</span><span class='hs-conop'>:</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span> 
<span class=hs-linenum>282: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PtrN</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>fplen</span> <span class='hs-varid'>fp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>  
<span class=hs-linenum>283: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>b</span>             
</pre>
</div>
<p>Refined API: Ops (2/3)</p>
<p><br></p>
<p><strong>Arithmetic</strong></p>
<p>Refine type to track <em>remaining</em> buffer size</p>
<p><br></p>
<div class="fragment">
<pre><span class=hs-linenum>299: </span><span class='hs-definition'>plusPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span>
<span class=hs-linenum>300: </span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>o</span><span class='hs-conop'>:</span><span class='hs-layout'>{</span><span class='hs-conid'>Nat</span><span class='hs-keyglyph'>|</span><span class='hs-varid'>o</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>p</span><span class='hs-layout'>}</span>   <span class='hs-comment'>-- in bounds</span>
<span class=hs-linenum>301: </span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PtrN</span> <span class='hs-varid'>b</span> <span class='hs-layout'>(</span><span class='hs-varid'>plen</span> <span class='hs-varid'>b</span> <span class='hs-comment'>-</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- remainder</span>
</pre>
</div>
<p>Refined API: Ops (3/3)</p>
<p><strong>Read &amp; Write require non-empty remaining buffer</strong></p>
<p><br></p>
<div class="fragment">
<p><strong>Read</strong></p>
<pre><span class=hs-linenum>316: </span><span class='hs-definition'>peek</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>|</span> <span class='hs-num'>0</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>  
</pre>
</div>
<br>
<div class="fragment">
<p><strong>Write</strong></p>
<pre><span class=hs-linenum>325: </span><span class='hs-definition'>poke</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>|</span> <span class='hs-num'>0</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>  
</pre>
</div>
<p></p>
<p>How to <em>prevent overflows</em> e.g. writing 5 or 50 zeros?</p>
<p><br></p>
<div class="fragment">
<pre><span class=hs-linenum>338: </span><a class=annot href="#"><span class=annottext>forall a. (IO (ForeignPtr a))</span><span class='hs-definition'>exBad</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr a) | 0 &lt;= fplen VV}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr a) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>malloc</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (4  :  int)}</span><span class='hs-num'>4</span></a>
<span class=hs-linenum>339: </span>           <a class=annot href="#"><span class=annottext>x1:(ForeignPtr a)
-&gt; ({v : (Ptr a) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v} -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v} -&gt; (IO ()))
 -&gt; (IO ()))
-&gt; ({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr a) | fplen fp == plen VV &amp;&amp; zero &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>340: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>341: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>342: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>343: </span>             <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a></span><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum>344: </span>           <a class=annot href="#"><span class=annottext>(ForeignPtr a) -&gt; (IO (ForeignPtr a))</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a>
<span class=hs-linenum>345: </span>        <span class='hs-keyword'>where</span>
<span class=hs-linenum>346: </span>           <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>zero</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-num'>0</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span>
</pre>
</div>
<h2 id="bytestring-api">2. ByteString API</h2>
<p><br></p>
<p>Strategy: Specify and Verify Types for</p>
<p><br></p>
<ol style="list-style-type: decimal">
<li>Low-level <code>Pointer</code> API</li>
<li><strong>Lib-level <code>ByteString</code> API</strong></li>
<li>User-level <code>Application</code> API</li>
</ol>
<p><br></p>
<p>Errors at <em>each</em> level are prevented by types at <em>lower</em> levels</p>
<p></p>
<p><img src="../img/bytestring.png" height=150px></p>
<pre><span class=hs-linenum>374: </span><span class='hs-keyword'>data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-layout'>{</span>
<span class=hs-linenum>375: </span>    <a class=annot href="#"><span class=annottext>ByteString -&gt; (ForeignPtr Word8)</span><span class='hs-varid'>bPtr</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>376: </span>  <span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>ByteString -&gt; Int</span><span class='hs-varid'>bOff</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<span class=hs-linenum>377: </span>  <span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>ByteString -&gt; Int</span><span class='hs-varid'>bLen</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<span class=hs-linenum>378: </span>  <span class='hs-layout'>}</span>
</pre>
<p></p>
<p><img src="../img/bytestring.png" height=150px></p>
<pre><span class=hs-linenum>387: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-layout'>{</span>
<span class=hs-linenum>388: </span>      <span class='hs-varid'>bPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>389: </span>    <span class='hs-layout'>,</span> <span class='hs-varid'>bOff</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span>        <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>bPtr</span><span class='hs-layout'>}</span>
<span class=hs-linenum>390: </span>    <span class='hs-layout'>,</span> <span class='hs-varid'>bLen</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bOff</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>bPtr</span><span class='hs-layout'>}</span>
<span class=hs-linenum>391: </span>    <span class='hs-layout'>}</span>                                       <span class='hs-keyword'>@-}</span>
</pre>
<p><img src="../img/bytestring.png" height=150px></p>
<p><br></p>
<p><strong>A Useful Abbreviation</strong></p>
<pre><span class=hs-linenum>402: </span><span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringN</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> 
</pre>
<div class="hidden">
<pre><span class=hs-linenum>408: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringN</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
</pre>
</div>
<p></p>
<p><br></p>
<pre><span class=hs-linenum>418: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>good1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-num'>5</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>419: </span><a class=annot href="#"><span class=annottext>(IO {v : ByteString | bLen v == 5})</span><span class='hs-definition'>good1</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen VV}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>malloc</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a>
<span class=hs-linenum>420: </span>           <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty}
-&gt; (IO {v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty})</span><span class='hs-varid'>return</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>421: </span>
<span class=hs-linenum>422: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>good2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>423: </span><a class=annot href="#"><span class=annottext>(IO {v : ByteString | bLen v == 3})</span><span class='hs-definition'>good2</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen VV}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>malloc</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a>
<span class=hs-linenum>424: </span>           <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty}
-&gt; (IO {v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty})</span><span class='hs-varid'>return</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a><span class='hs-layout'>)</span>
</pre>
<p><br></p>
<div class="fragment">
<strong>Note:</strong> <em>length</em> of <code>good2</code> is <code>3</code> which is <em>less than</em> allocated size <code>5</code>
</div>
<p></p>
<p><br></p>
<pre><span class=hs-linenum>438: </span><a class=annot href="#"><span class=annottext>(IO ByteString)</span><span class='hs-definition'>bad1</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen VV}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>malloc</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a> 
<span class=hs-linenum>439: </span>          <a class=annot href="#"><span class=annottext>ByteString -&gt; (IO ByteString)</span><span class='hs-varid'>return</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (10  :  int)}</span><span class='hs-num'>10</span></a></span><span class='hs-layout'>)</span>
<span class=hs-linenum>440: </span>
<span class=hs-linenum>441: </span><a class=annot href="#"><span class=annottext>(IO ByteString)</span><span class='hs-definition'>bad2</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen VV}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>malloc</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a>
<span class=hs-linenum>442: </span>          <a class=annot href="#"><span class=annottext>ByteString -&gt; (IO ByteString)</span><span class='hs-varid'>return</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a></span><span class='hs-layout'>)</span>
</pre>
<p><br></p>
<div class="fragment">
Claimed length <em>exceeds</em> allocation ... <strong>rejected</strong> at compile time
</div>
<p></p>
<div class="hidden">
<pre><span class=hs-linenum>455: </span><span class='hs-definition'>create</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
</pre>
</div>
<p><em>Allocate</em> and <em>fill</em> a <code>ByteString</code></p>
<p><br></p>
<div class="fragment">
<p><strong>Specification</strong></p>
<pre><span class=hs-linenum>466: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>create</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PtrN</span> <span class='hs-conid'>Word8</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<span class=hs-linenum>467: </span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteStringN</span> <span class='hs-varid'>n</span>                <span class='hs-keyword'>@-}</span>
</pre>
</div>
<div class="fragment">
<p><strong>Implementation</strong></p>
<pre><span class=hs-linenum>476: </span><a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; ({VV : (Ptr Word8) | plen VV == x1 &amp;&amp; 0 &lt;= plen VV} -&gt; (IO ()))
-&gt; {v : ByteString | bLen v == x1}</span><span class='hs-definition'>create</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | plen VV == n &amp;&amp; 0 &lt;= plen VV} -&gt; (IO ())</span><span class='hs-varid'>fill</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(IO {v : ByteString | bLen v == n})
-&gt; {v : ByteString | bLen v == n}</span><span class='hs-varid'>unsafePerformIO</span></a> <a class=annot href="#"><span class=annottext>((IO {v : ByteString | bLen v == n})
 -&gt; {v : ByteString | bLen v == n})
-&gt; (IO {v : ByteString | bLen v == n})
-&gt; {v : ByteString | bLen v == n}</span><span class='hs-varop'>$</span></a> <span class='hs-keyword'>do</span>
<span class=hs-linenum>477: </span>  <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | fplen VV == n &amp;&amp; 0 &lt;= fplen VV}</span><span class='hs-varid'>fp</span></a>  <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>malloc</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a>
<span class=hs-linenum>478: </span>  <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; fplen v == n &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | plen v == n &amp;&amp; 0 &lt;= plen v} -&gt; (IO ())</span><span class='hs-varid'>fill</span></a> 
<span class=hs-linenum>479: </span>  <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == n}
-&gt; (IO {v : ByteString | bLen v == n})</span><span class='hs-varid'>return</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; fplen v == n &amp;&amp; 0 &lt;= fplen v}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a><span class='hs-layout'>)</span>
</pre>
</div>
<!-- CUT
<div class="fragment">
Yikes, there is an error! How to fix?
</div>
-->
<p></p>
<p><strong>Specification</strong></p>
<pre><span class=hs-linenum>494: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>pack</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteStringN</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
</pre>
<p><br></p>
<div class="fragment">
<p><strong>Implementation</strong></p>
<pre><span class=hs-linenum>504: </span><a class=annot href="#"><span class=annottext>x1:[Char] -&gt; {v : ByteString | bLen v == len x1}</span><span class='hs-definition'>pack</span></a> <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>str</span></a>      <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; ({v : (Ptr Word8) | plen v == x1 &amp;&amp; 0 &lt;= plen v} -&gt; (IO ()))
-&gt; {v : ByteString | bLen v == x1}</span><span class='hs-varid'>create</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v == len str}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr Word8) | plen v == n &amp;&amp; plen v == len xs &amp;&amp; plen v == len str &amp;&amp; 0 &lt;= plen v &amp;&amp; n &lt;= plen v}
  -&gt; (IO ()))
 -&gt; {v : ByteString | bLen v == n &amp;&amp; bLen v == len str})
-&gt; ({v : (Ptr Word8) | plen v == n &amp;&amp; plen v == len xs &amp;&amp; plen v == len str &amp;&amp; 0 &lt;= plen v &amp;&amp; n &lt;= plen v}
    -&gt; (IO ()))
-&gt; {v : ByteString | bLen v == n &amp;&amp; bLen v == len str}</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | plen v == n &amp;&amp; plen v == len xs &amp;&amp; plen v == len str &amp;&amp; 0 &lt;= plen v &amp;&amp; n &lt;= plen v}
-&gt; (IO ())</span><span class='hs-keyglyph'>\</span></a><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | plen VV == n &amp;&amp; plen VV == len xs &amp;&amp; plen VV == len str &amp;&amp; 0 &lt;= plen VV &amp;&amp; n &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | plen v == len str}
-&gt; {v : [Word8] | len v == len str &amp;&amp; len v &gt;= 0 &amp;&amp; len v &lt;= plen x1}
-&gt; (IO ())</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; plen v == n &amp;&amp; plen v == len xs &amp;&amp; plen v == len str &amp;&amp; 0 &lt;= plen v &amp;&amp; n &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : [Word8] | v == xs &amp;&amp; len v == len str &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>505: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>506: </span>  <a class=annot href="#"><span class=annottext>{v : Int | v == len str}</span><span class='hs-varid'>n</span></a>           <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:[Char] -&gt; {v : Int | v == len x1}</span><span class='hs-varid'>length</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == str &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>str</span></a>
<span class=hs-linenum>507: </span>  <a class=annot href="#"><span class=annottext>{v : [Word8] | len v == len str}</span><span class='hs-varid'>xs</span></a>          <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(Char -&gt; Word8) -&gt; x3:[Char] -&gt; {v : [Word8] | len v == len x3}</span><span class='hs-varid'>map</span></a> <a class=annot href="#"><span class=annottext>Char -&gt; Word8</span><span class='hs-varid'>c2w</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == str &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>str</span></a>
<span class=hs-linenum>508: </span>  <a class=annot href="#"><span class=annottext>forall a.
(Storable [Bivariant]
[] a) =&gt;
x1:{VV : (Ptr a) | plen VV == len str}
-&gt; {VV : [a] | len VV == len str &amp;&amp; len VV &gt;= 0 &amp;&amp; len VV &lt;= plen x1}
-&gt; (IO ())</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>(Ptr a)</span><span class='hs-varid'>p</span></a> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | 0 &lt; plen v} -&gt; a -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{VV : a | VV == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>(IO ()) -&gt; (IO ()) -&gt; (IO ())</span><span class='hs-varop'>&gt;&gt;</span></a> <a class=annot href="#"><span class=annottext>x1:(Ptr a)
-&gt; {VV : [a] | len VV &gt;= 0 &amp;&amp; len VV &lt;= plen x1 &amp;&amp; len VV &lt;= len str}
-&gt; (IO ())</span><span class='hs-varid'>go</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr a) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>plusPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : [a] | v == xs &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>509: </span>  <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>() -&gt; (IO ())</span><span class='hs-varid'>return</span></a>  <a class=annot href="#"><span class=annottext>{v : () | v == GHC.Tuple.()}</span><span class='hs-conid'>()</span></a>
</pre>
</div>
<p></p>
<p>Extract <em>prefix</em> string of size <code>n</code></p>
<p><br></p>
<div class="fragment">
<p><strong>Specification</strong></p>
<pre><span class=hs-linenum>526: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeTake</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span>
<span class=hs-linenum>527: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-keyword'>{ByteString | n &lt;= bLen b}</span>
<span class=hs-linenum>528: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteStringN</span> <span class='hs-varid'>n</span>            <span class='hs-keyword'>@-}</span>
</pre>
</div>
<p><br></p>
<div class="fragment">
<p><strong>Implementation</strong></p>
<pre><span class=hs-linenum>539: </span><a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; {b : ByteString | x1 &lt;= bLen b}
-&gt; {v : ByteString | bLen v == x1}</span><span class='hs-definition'>unsafeTake</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>n</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen x}</span><span class='hs-varid'>s</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a>
</pre>
</div>
<p></p>
<p><strong>Specification</strong></p>
<pre><span class=hs-linenum>548: </span><span class='hs-definition'>unpack</span> 
<span class=hs-linenum>549: </span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StringN</span> <span class='hs-layout'>(</span><span class='hs-varid'>bLen</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
</pre>
<p><br></p>
<div class="fragment">
<p><strong>Implementation</strong></p>
<pre><span class=hs-linenum>558: </span><span class='hs-definition'>unpack</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>you</span> <span class='hs-varop'>.</span> <span class='hs-varid'>get</span> <span class='hs-varop'>.</span> <span class='hs-varid'>the</span> <span class='hs-varop'>.</span> <span class='hs-varid'>idea</span> <span class='hs-comment'>-- see source </span>
</pre>
</div>
<div class="hidden">
<pre><span class=hs-linenum>564: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>Unpack</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-varid'>int</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>len</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>len</span> <span class='hs-varid'>acc</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>565: </span>
<span class=hs-linenum>566: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unpack</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StringN</span> <span class='hs-layout'>(</span><span class='hs-varid'>bLen</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>567: </span><span class='hs-definition'>unpack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> 
<span class=hs-linenum>568: </span><a class=annot href="#"><span class=annottext>x1:ByteString -&gt; {VV : [Char] | len VV == bLen x1}</span><span class='hs-definition'>unpack</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>forall a &lt;p :: a a -&gt; Prop&gt;.
{v : [a]&lt;\x5 VV -&gt; p x5&gt; | null v &lt;=&gt; true &amp;&amp; len v == 0 &amp;&amp; bLens v == 0}</span><span class='hs-conid'>[]</span></a>
<span class=hs-linenum>569: </span><span class='hs-definition'>unpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(IO {v : [Char] | len v &gt; 0}) -&gt; {v : [Char] | len v &gt; 0}</span><span class='hs-varid'>unsafePerformIO</span></a> <a class=annot href="#"><span class=annottext>((IO {v : [Char] | len v &gt; 0}) -&gt; {v : [Char] | len v &gt; 0})
-&gt; (IO {v : [Char] | len v &gt; 0}) -&gt; {v : [Char] | len v &gt; 0}</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO {v : [Char] | len v &gt; 0}))
-&gt; (IO {v : [Char] | len v &gt; 0})</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>(ForeignPtr Word8)</span><span class='hs-varid'>ps</span></a> <a class=annot href="#"><span class=annottext>((x5:{v : (Ptr Word8) | 0 &lt;= plen v}
  -&gt; (IO {v : [Char] | len v &gt; 0 &amp;&amp; len v &lt;= plen x5}))
 -&gt; (IO {v : [Char] | len v &gt; 0}))
-&gt; (x5:{v : (Ptr Word8) | 0 &lt;= plen v}
    -&gt; (IO {v : [Char] | len v &gt; 0 &amp;&amp; len v &lt;= plen x5}))
-&gt; (IO {v : [Char] | len v &gt; 0})</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | 0 &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>570: </span>   <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen x1}
-&gt; x3:{v : [Char] | len v &gt;= 0}
-&gt; (IO {v : [Char] | len v == 1 + x2 + len x3 &amp;&amp; v /= x3 &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len x3})</span><span class='hs-varid'>go</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>s</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>l</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 - x2}</span><span class='hs-comment'>-</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span>  <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; true &amp;&amp; len v == 0 &amp;&amp; bLens v == 0 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-conid'>[]</span></a>
<span class=hs-linenum>571: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>572: </span>   <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen x1}
-&gt; x3:{v : [Char] | len v &gt;= 0}
-&gt; (IO {v : [Char] | len v == 1 + x2 + len x3 &amp;&amp; v /= x3 &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len x3})</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | 0 &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-num'>0</span> <a class=annot href="#"><span class=annottext>{VV : [Char] | len VV &gt;= 0}</span><span class='hs-varid'>acc</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt; plen v}
-&gt; (IO {v : Word8 | v == deref x1})</span><span class='hs-varid'>peek</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>(IO Word8)
-&gt; (Word8
    -&gt; (IO {v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc}))
-&gt; (IO {v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc})</span><span class='hs-varop'>&gt;&gt;=</span></a> <a class=annot href="#"><span class=annottext>Word8
-&gt; (IO {v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc})</span><span class='hs-keyglyph'>\</span></a><a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>e</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>{v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc}
-&gt; (IO {v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc})</span><span class='hs-varid'>return</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>Word8 -&gt; Char</span><span class='hs-varid'>w2c</span></a> <a class=annot href="#"><span class=annottext>{v : Word8 | v == e}</span><span class='hs-varid'>e</span></a> <a class=annot href="#"><span class=annottext>x1:Char
-&gt; x2:[Char]
-&gt; {v : [Char] | null v &lt;=&gt; false &amp;&amp; xListSelector v == x1 &amp;&amp; len v == 1 + len x2 &amp;&amp; xsListSelector v == x2 &amp;&amp; bLens v == bLen x1 + bLens x2}</span><span class='hs-conop'>:</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == acc &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>acc</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>573: </span>   <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt; plen v}
-&gt; (IO {v : Word8 | v == deref x1})</span><span class='hs-varid'>peek</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen p}</span><span class='hs-varid'>n</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>(IO Word8)
-&gt; (Word8
    -&gt; (IO {v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc}))
-&gt; (IO {v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc})</span><span class='hs-varop'>&gt;&gt;=</span></a>   <a class=annot href="#"><span class=annottext>Word8
-&gt; (IO {v : [Char] | v /= acc &amp;&amp; len v &gt; 0 &amp;&amp; len v &gt; len acc})</span><span class='hs-keyglyph'>\</span></a><a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>e</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>x1:{VV : (Ptr Word8) | 0 &lt;= plen VV}
-&gt; x2:{VV : Int | VV &gt;= 0 &amp;&amp; VV &lt;= plen x1}
-&gt; x3:{VV : [Char] | len VV &gt;= 0}
-&gt; (IO {VV : [Char] | len VV == 1 + x2 + len x3 &amp;&amp; VV /= x3 &amp;&amp; len VV &gt; 0 &amp;&amp; len VV &gt; len x3})</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen p}</span><span class='hs-varid'>n</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 - x2}</span><span class='hs-comment'>-</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>Word8 -&gt; Char</span><span class='hs-varid'>w2c</span></a> <a class=annot href="#"><span class=annottext>{v : Word8 | v == e}</span><span class='hs-varid'>e</span></a> <a class=annot href="#"><span class=annottext>x1:Char
-&gt; x2:[Char]
-&gt; {v : [Char] | null v &lt;=&gt; false &amp;&amp; xListSelector v == x1 &amp;&amp; len v == 1 + len x2 &amp;&amp; xsListSelector v == x2 &amp;&amp; bLens v == bLen x1 + bLens x2}</span><span class='hs-conop'>:</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == acc &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>acc</span></a><span class='hs-layout'>)</span>
</pre>
</div>
<h2 id="application-api">3. Application API</h2>
<p><br></p>
<p>Strategy: Specify and Verify Types for</p>
<p><br></p>
<ol style="list-style-type: decimal">
<li>Low-level <code>Pointer</code> API</li>
<li>Lib-level <code>ByteString</code> API</li>
<li><strong>User-level <code>Application</code> API</strong></li>
</ol>
<p><br></p>
<p>Errors at <em>each</em> level are prevented by types at <em>lower</em> levels</p>
<p></p>
<p>Lets revisit our potentially &quot;bleeding&quot; <code>chop</code></p>
<p><br></p>
<div class="hidden">
<pre><span class=hs-linenum>603: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>StringN</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
</pre>
</div>
<div class="fragment">
<pre><span class=hs-linenum>609: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>chop</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-conid'>String</span>
<span class=hs-linenum>610: </span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-keyword'>{Nat | n &lt;= len s}</span>
<span class=hs-linenum>611: </span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StringN</span> <span class='hs-varid'>n</span>
<span class=hs-linenum>612: </span>  <span class='hs-keyword'>@-}</span> 
<span class=hs-linenum>613: </span><a class=annot href="#"><span class=annottext>x1:[Char]
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= len x1}
-&gt; {VV : [Char] | len VV == x2}</span><span class='hs-definition'>chop</span></a> <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>s</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0 &amp;&amp; v &lt;= len s}</span><span class='hs-varid'>n</span></a> <span class='hs-keyglyph'>=</span>  <a class=annot href="#"><span class=annottext>{v : [Char] | v == s' &amp;&amp; len v == bLen b' &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>s'</span></a>
<span class=hs-linenum>614: </span>  <span class='hs-keyword'>where</span> 
<span class=hs-linenum>615: </span>    <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == len s}</span><span class='hs-varid'>b</span></a>    <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:[Char] -&gt; {v : ByteString | bLen v == len x1}</span><span class='hs-varid'>pack</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == s &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>s</span></a>          <span class='hs-comment'>-- down to low-level</span>
<span class=hs-linenum>616: </span>    <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == n}</span><span class='hs-varid'>b'</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; {v : ByteString | x1 &lt;= bLen v}
-&gt; {v : ByteString | bLen v == x1}</span><span class='hs-varid'>unsafeTake</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= len s}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == b &amp;&amp; bLen v == len s &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>b</span></a>  <span class='hs-comment'>-- grab n chars</span>
<span class=hs-linenum>617: </span>    <a class=annot href="#"><span class=annottext>{v : [Char] | len v == bLen b'}</span><span class='hs-varid'>s'</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:ByteString -&gt; {v : [Char] | len v == bLen x1}</span><span class='hs-varid'>unpack</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == b' &amp;&amp; bLen v == n &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>b'</span></a>       <span class='hs-comment'>-- up to high-level</span>
</pre>
<!-- BEGIN CUT 
<br>

Yikes! How shall we fix it?

     END CUT -->
</div>
<!-- BEGIN CUT

A Well Typed `chop`
-------------------


<pre><span class=hs-linenum>634: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>chop</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-conid'>String</span>
<span class=hs-linenum>635: </span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-keyword'>{Nat | n &lt;= len s}</span>
<span class=hs-linenum>636: </span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>String</span> <span class='hs-keyword'>| len v = n}</span> <span class='hs-keyword'>@-}</span> 
<span class=hs-linenum>637: </span><span class='hs-definition'>chop</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s'</span>
<span class=hs-linenum>638: </span>  <span class='hs-keyword'>where</span> 
<span class=hs-linenum>639: </span>    <span class='hs-varid'>b</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pack</span> <span class='hs-varid'>s</span>          <span class='hs-comment'>-- down to low-level</span>
<span class=hs-linenum>640: </span>    <span class='hs-varid'>b'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeTake</span> <span class='hs-varid'>n</span> <span class='hs-varid'>b</span>  <span class='hs-comment'>-- grab n chars</span>
<span class=hs-linenum>641: </span>    <span class='hs-varid'>s'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpack</span> <span class='hs-varid'>b'</span>       <span class='hs-comment'>-- up to high-level</span>
</pre>

END CUT -->
<p></p>
<p><br></p>
<pre><span class=hs-linenum>651: </span><a class=annot href="#"><span class=annottext>[[Char]]</span><span class='hs-definition'>demo</span></a>     <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : [[Char]] | null v &lt;=&gt; false &amp;&amp; xListSelector v == ex30 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-keyglyph'>[</span></a><a class=annot href="#"><span class=annottext>{v : [Char] | v == ex6 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex6</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>{v : [Char] | v == ex30 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex30</span></a><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>652: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>653: </span>    <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false}</span><span class='hs-varid'>ex</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false}</span><span class='hs-keyglyph'>[</span></a><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'N'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'o'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'r'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'m'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'a'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'n'</span></a><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>654: </span>    <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>ex6</span></a>  <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:[Char]
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= len x1}
-&gt; {v : [Char] | len v == v}</span><span class='hs-varid'>chop</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false &amp;&amp; v == ex &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (6  :  int)}</span><span class='hs-num'>6</span></a>  <span class='hs-comment'>-- ok</span>
<span class=hs-linenum>655: </span>    <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>ex30</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:[Char]
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= len x1}
-&gt; {v : [Char] | len v == v}</span><span class='hs-varid'>chop</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false &amp;&amp; v == ex &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (30  :  int)}</span><span class='hs-num'>30</span></a></span>  <span class='hs-comment'>-- out of bounds</span>
</pre>
<p><br></p>
<p>&quot;Bleeding&quot; <code>chop ex 30</code> <em>rejected</em> by compiler</p>
<h2 id="nested-bytestrings">Nested ByteStrings</h2>
<p>For a more in depth example, let's take a look at <code>group</code>, which transforms strings like</p>
<p><code>&quot;foobaaar&quot;</code></p>
<p>into <em>lists</em> of strings like</p>
<p><code>[&quot;f&quot;,&quot;oo&quot;, &quot;b&quot;, &quot;aaa&quot;, &quot;r&quot;]</code>.</p>
<p>The specification is that <code>group</code> should produce a list of <code>ByteStrings</code></p>
<ol style="list-style-type: decimal">
<li>that are all <em>non-empty</em> (safety)</li>
<li>the sum of whose lengths is equal to the length of the input string (precision)</li>
</ol>
<p>We use the type alias</p>
<pre><span class=hs-linenum>682: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringNE</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
</pre>
<p>to specify (safety) and introduce a new measure</p>
<pre><span class=hs-linenum>688: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>measure</span> <span class='hs-varid'>bLens</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<span class=hs-linenum>689: </span>    <span class='hs-varid'>bLens</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<span class=hs-linenum>690: </span>    <span class='hs-varid'>bLens</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bLen</span> <span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bLens</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<span class=hs-linenum>691: </span>  <span class='hs-keyword'>@-}</span>
</pre>
<p>to specify (precision). The full type-specification looks like this:</p>
<pre><span class=hs-linenum>697: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>group</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteStringNE</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>| bLens v = bLen b}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>698: </span><a class=annot href="#"><span class=annottext>x1:ByteString
-&gt; {v : [{v : ByteString | bLen v &gt; 0}] | bLens v == bLen x1}</span><span class='hs-definition'>group</span></a> <a class=annot href="#"><span class=annottext>ByteString</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>699: </span>    <span class='hs-keyglyph'>|</span> <a class=annot href="#"><span class=annottext>x1:ByteString -&gt; {v : Bool | Prop v &lt;=&gt; bLen x1 == 0}</span><span class='hs-varid'>null</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>forall a &lt;p :: a a -&gt; Prop&gt;.
{v : [a]&lt;\x5 VV -&gt; p x5&gt; | null v &lt;=&gt; true &amp;&amp; len v == 0 &amp;&amp; bLens v == 0}</span><span class='hs-conid'>[]</span></a>
<span class=hs-linenum>700: </span>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>y</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v &gt; 0} -&gt; Word8</span><span class='hs-varid'>unsafeHead</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>701: </span>                      <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{VV : ByteString | VV == ys &amp;&amp; bLen Memory.empty + bLen VV == bLen ys &amp;&amp; VV /= xs}</span><span class='hs-varid'>ys</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>{VV : ByteString | VV == zs &amp;&amp; bLen Memory.empty + bLen VV == bLen zs &amp;&amp; VV /= xs}</span><span class='hs-varid'>zs</span></a><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Word8
-&gt; x2:ByteString
-&gt; (ByteString, ByteString)&lt;\x3 VV -&gt; bLen x3 + bLen v == bLen x2&gt;</span><span class='hs-varid'>spanByte</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : ByteString | bLen v &gt; 0} -&gt; Word8</span><span class='hs-varid'>unsafeHead</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:{v : ByteString | bLen v &gt; 0}
-&gt; {v : ByteString | bLen v == bLen x1 - 1}</span><span class='hs-varid'>unsafeTail</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>702: </span>                  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Word8 | v == y}</span><span class='hs-varid'>y</span></a> <a class=annot href="#"><span class=annottext>Word8 -&gt; x2:ByteString -&gt; {v : ByteString | bLen v == 1 + bLen v}</span><span class='hs-varop'>`cons`</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == ys &amp;&amp; v == ys &amp;&amp; bLen Memory.empty + bLen v == bLen ys &amp;&amp; v /= xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ys</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>x1:{v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0}
-&gt; x2:[{v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0}]&lt;\_ VV -&gt; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;
-&gt; {v : [{v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0}]&lt;\_ VV -&gt; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt; | null v &lt;=&gt; false &amp;&amp; xListSelector v == x1 &amp;&amp; len v == 1 + len x2 &amp;&amp; xsListSelector v == x2 &amp;&amp; bLens v == bLen x1 + bLens x2}</span><span class='hs-conop'>:</span></a> <a class=annot href="#"><span class=annottext>x1:ByteString
-&gt; {v : [{v : ByteString | bLen v &gt; 0}] | bLens v == bLen x1}</span><span class='hs-varid'>group</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == zs &amp;&amp; v == zs &amp;&amp; bLen Memory.empty + bLen v == bLen zs &amp;&amp; v /= xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>zs</span></a>
</pre>
<p>As you can probably tell, <code>spanByte</code> appears to be doing a lot of the work here, so let's take a closer look at it to see why the post-condition holds.</p>
<pre><span class=hs-linenum>709: </span><span class='hs-definition'>spanByte</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span>
<span class=hs-linenum>710: </span><a class=annot href="#"><span class=annottext>Word8
-&gt; x2:ByteString
-&gt; (ByteString, ByteString)&lt;\x14 VV -&gt; bLen x14 + bLen VV == bLen x2&gt;</span><span class='hs-definition'>spanByte</span></a> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>c</span></a> <a class=annot href="#"><span class=annottext>ByteString</span><span class='hs-varid'>ps</span></a><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(IO (ByteString, ByteString)&lt;\x10 VV -&gt; bLen x10 + bLen v == bLen ps&gt;)
-&gt; (ByteString, ByteString)&lt;\x3 VV -&gt; bLen x3 + bLen v == bLen ps&gt;</span><span class='hs-varid'>unsafePerformIO</span></a> <a class=annot href="#"><span class=annottext>((IO (ByteString, ByteString)&lt;\x23 VV -&gt; bLen x23 + bLen v == bLen ps&gt;)
 -&gt; (ByteString, ByteString)&lt;\x16 VV -&gt; bLen x16 + bLen v == bLen ps&gt;)
-&gt; (IO (ByteString, ByteString)&lt;\x23 VV -&gt; bLen x23 + bLen v == bLen ps&gt;)
-&gt; (ByteString, ByteString)&lt;\x16 VV -&gt; bLen x16 + bLen v == bLen ps&gt;</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO (ByteString, ByteString)&lt;\x11 VV -&gt; bLen x11 + bLen v == bLen ps&gt;))
-&gt; (IO (ByteString, ByteString)&lt;\x11 VV -&gt; bLen x11 + bLen v == bLen ps&gt;)</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}
  -&gt; (IO (ByteString, ByteString)&lt;\x33 VV -&gt; bLen x33 + bLen v == bLen ps&gt;))
 -&gt; (IO (ByteString, ByteString)&lt;\x25 VV -&gt; bLen x25 + bLen v == bLen ps&gt;))
-&gt; ({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}
    -&gt; (IO (ByteString, ByteString)&lt;\x33 VV -&gt; bLen x33 + bLen v == bLen ps&gt;))
-&gt; (IO (ByteString, ByteString)&lt;\x25 VV -&gt; bLen x25 + bLen v == bLen ps&gt;)</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | fplen x == plen VV &amp;&amp; 0 &lt;= plen VV &amp;&amp; l &lt;= plen VV &amp;&amp; s &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>711: </span>    <a class=annot href="#"><span class=annottext>{v : (Ptr (Any *)) | l &lt;= plen v}
-&gt; x2:{v : Int | v == 0 &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l &amp;&amp; v &lt;= s}
-&gt; (IO (ByteString, ByteString)&lt;\x4 VV -&gt; bLen x4 + bLen v == bLen ps &amp;&amp; x2 &lt;= bLen v&gt;)</span><span class='hs-varid'>go</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr (Any *)) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen x}</span><span class='hs-varid'>s</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a>
<span class=hs-linenum>712: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>713: </span>    <a class=annot href="#"><span class=annottext>forall a.
{VV : (Ptr a) | l &lt;= plen VV}
-&gt; x2:{VV : Int | VV == 0 &amp;&amp; VV &gt;= 0 &amp;&amp; VV &lt;= l &amp;&amp; VV &lt;= s}
-&gt; (IO (ByteString, ByteString)&lt;\x1 VV -&gt; bLen x1 + bLen VV == bLen ps &amp;&amp; x2 &lt;= bLen VV&gt;)</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr a) | l &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{VV : Int | VV &gt;= 0 &amp;&amp; VV &lt;= l}</span><span class='hs-varid'>i</span></a> <span class='hs-keyglyph'>|</span> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &gt;= v}</span><span class='hs-varop'>&gt;=</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen x}</span><span class='hs-varid'>l</span></a>    <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(ByteString, ByteString)&lt;\x42 VV -&gt; v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen v == bLen x42 - l &amp;&amp; bLen v == bLen x42 - i &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps &amp;&amp; bLen ps + bLen v == bLen x42 &amp;&amp; bLen x42 + bLen v == bLen ps &amp;&amp; bLen x42 + bLen v == bLen x42&gt;
-&gt; (IO (ByteString, ByteString)&lt;\x42 VV -&gt; v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen v == bLen x42 - l &amp;&amp; bLen v == bLen x42 - i &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps &amp;&amp; bLen ps + bLen v == bLen x42 &amp;&amp; bLen x42 + bLen v == bLen ps &amp;&amp; bLen x42 + bLen v == bLen x42&gt;)</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>{v : (ByteString, {v : ByteString | v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps})&lt;\x21 VV -&gt; v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen v == bLen x21 - l &amp;&amp; bLen v == bLen x21 - i &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps &amp;&amp; bLen ps + bLen v == bLen x21 &amp;&amp; bLen x21 + bLen v == bLen ps &amp;&amp; bLen x21 + bLen v == bLen x21&gt; | x_Tuple22 v == Memory.empty &amp;&amp; snd v == Memory.empty}</span><span class='hs-layout'>(</span></a><a class=annot href="#"><span class=annottext>{v : ByteString | v == ps &amp;&amp; v == Memory.PS x s l &amp;&amp; bLen v == l &amp;&amp; bOff v == s &amp;&amp; bPtr v == x &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ps</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>{v : ByteString | v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>empty</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>714: </span>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>c'</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>p:(Ptr a) -&gt; {v : Int | v &lt; plen p &amp;&amp; 0 &lt;= v} -&gt; (IO Word8)</span><span class='hs-varid'>peekByteOff</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; l &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a>
<span class=hs-linenum>715: </span>                            <span class='hs-keyword'>if</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == c}</span><span class='hs-varid'>c</span></a> <a class=annot href="#"><span class=annottext>x1:Word8 -&gt; x2:Word8 -&gt; {v : Bool | Prop v &lt;=&gt; x1 /= v}</span><span class='hs-varop'>/=</span></a> <a class=annot href="#"><span class=annottext>{v : Word8 | v == c'}</span><span class='hs-varid'>c'</span></a>
<span class=hs-linenum>716: </span>                                <span class='hs-keyword'>then</span> <a class=annot href="#"><span class=annottext>(ByteString, ByteString)&lt;\x15 VV -&gt; bLen v == bLen ps - i &amp;&amp; bLen x15 + bLen v == bLen ps &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;
-&gt; (IO (ByteString, ByteString)&lt;\x15 VV -&gt; bLen v == bLen ps - i &amp;&amp; bLen x15 + bLen v == bLen ps &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;)</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>(ByteString, {v : ByteString | bLen v == bLen ps - i &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0})&lt;\x4 VV -&gt; bLen v == bLen ps - i &amp;&amp; bLen x4 + bLen v == bLen ps &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;</span><span class='hs-layout'>(</span></a><a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; {v : ByteString | x1 &lt;= bLen v}
-&gt; {v : ByteString | bLen v == x1}</span><span class='hs-varid'>unsafeTake</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == ps &amp;&amp; v == Memory.PS x s l &amp;&amp; bLen v == l &amp;&amp; bOff v == s &amp;&amp; bPtr v == x &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ps</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; x2:{v : ByteString | x1 &lt;= bLen v}
-&gt; {v : ByteString | bLen v == bLen v - x1}</span><span class='hs-varid'>unsafeDrop</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == ps &amp;&amp; v == Memory.PS x s l &amp;&amp; bLen v == l &amp;&amp; bOff v == s &amp;&amp; bPtr v == x &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ps</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>717: </span>                                <span class='hs-keyword'>else</span> <a class=annot href="#"><span class=annottext>{VV : (Ptr a) | l &lt;= plen VV}
-&gt; {VV : Int | VV &gt;= 0 &amp;&amp; VV &lt;= l}
-&gt; (IO (ByteString, ByteString)&lt;\x1 VV -&gt; bLen x1 + bLen VV == bLen ps&gt;)</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; l &lt;= plen v}</span><span class='hs-varid'>p</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 + x2}</span><span class='hs-varop'>+</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span>
</pre>
<p>LiquidHaskell infers that <code>0 &lt;= i &lt;= l</code> and therefore that all of the memory accesses are safe. Furthermore, due to the precise specifications given to <code>unsafeTake</code> and <code>unsafeDrop</code>, it is able to prove that <code>spanByte</code> has the type</p>
<pre><span class=hs-linenum>725: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>spanByte</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringPair</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
</pre>
<p>where <code>ByteStringPair b</code> describes a pair of <code>ByteString</code>s whose lengths sum to the length of <code>b</code>.</p>
<pre><span class=hs-linenum>732: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringPair</span> <span class='hs-conid'>B</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span><span class='hs-varop'>&lt;</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x1</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>733: </span>       <span class='hs-varid'>bLen</span> <span class='hs-varid'>x1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bLen</span> <span class='hs-conid'>B</span><span class='hs-layout'>}</span><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>@-}</span>
</pre>
<h2 id="recap-types-against-overflows">Recap: Types Against Overflows</h2>
<p><br></p>
<p><strong>Strategy: Specify and Verify Types for</strong></p>
<p><br></p>
<ol style="list-style-type: decimal">
<li>Low-level <code>Pointer</code> API</li>
<li>Lib-level <code>ByteString</code> API</li>
<li>User-level <code>Application</code> API</li>
</ol>
<p><br></p>
<p><strong>Errors at <em>each</em> level are prevented by types at <em>lower</em> levels</strong></p>

<head>
<link type='text/css' rel='stylesheet' href='liquid.css' />
</head>
