<pre><span class=hs-linenum>  3: </span>
<span class=hs-linenum>  4: </span><span class='hs-comment'>{-# LANGUAGE ForeignFunctionInterface #-}</span>
<span class=hs-linenum>  5: </span>
<span class=hs-linenum>  6: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--no-termination"</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  7: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--short-names"</span>    <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  8: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--diffcheck"</span>     <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  9: </span>
<span class=hs-linenum> 10: </span><span class='hs-keyword'>module</span> <span class='hs-conid'>Memory</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum> 11: </span>
<span class=hs-linenum> 12: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 13: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<span class=hs-linenum> 14: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>
<span class=hs-linenum> 15: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<span class=hs-linenum> 16: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>ForeignPtr</span>
<span class=hs-linenum> 17: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Ptr</span>
<span class=hs-linenum> 18: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span>
<span class=hs-linenum> 19: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span>
<span class=hs-linenum> 20: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span> <span class='hs-layout'>(</span><span class='hs-varid'>c2w</span><span class='hs-layout'>,</span> <span class='hs-varid'>w2c</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 21: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Liquid</span><span class='hs-varop'>.</span><span class='hs-conid'>Prelude</span>
<span class=hs-linenum> 22: </span>
<span class=hs-linenum> 23: </span>
<span class=hs-linenum> 24: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 25: </span><span class='hs-comment'>-- | 1. Low-level Pointer API  -----------------------------------------</span>
<span class=hs-linenum> 26: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 27: </span>
<span class=hs-linenum> 28: </span><span class='hs-comment'>-- | Create a buffer of size 4 and initialize it with zeros</span>
<span class=hs-linenum> 29: </span>
<span class=hs-linenum> 30: </span><a class=annot href="#"><span class=annottext>forall a. (IO (ForeignPtr a))</span><span class='hs-definition'>zero4</span></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>(ForeignPtr a)</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr a) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>mallocForeignPtrBytes</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (4  :  int)}</span><span class='hs-num'>4</span></a>
<span class=hs-linenum> 31: </span>            <a class=annot href="#"><span class=annottext>x1:(ForeignPtr a)
-&gt; ({v : (Ptr a) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v} -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v} -&gt; (IO ()))
 -&gt; (IO ()))
-&gt; ({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr a) | fplen fp == plen VV &amp;&amp; zero &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum> 32: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 33: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 34: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 35: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 36: </span>            <a class=annot href="#"><span class=annottext>(ForeignPtr a) -&gt; (IO (ForeignPtr a))</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp}</span><span class='hs-varid'>fp</span></a>
<span class=hs-linenum> 37: </span>        <span class='hs-keyword'>where</span>
<span class=hs-linenum> 38: </span>            <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>zero</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-num'>0</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum> 39: </span>
<span class=hs-linenum> 40: </span><span class='hs-comment'>-- But whats to prevent an overflow, e.g. writing to offset 5 or 50?</span>
<span class=hs-linenum> 41: </span>            
<span class=hs-linenum> 42: </span>
<span class=hs-linenum> 43: </span>
<span class=hs-linenum> 44: </span><span class='hs-comment'>-- | Types for Pointers</span>
<span class=hs-linenum> 45: </span>
<span class=hs-linenum> 46: </span><span class='hs-comment'>-- data Ptr a         </span>
<span class=hs-linenum> 47: </span><span class='hs-comment'>-- data ForeignPtr a </span>
<span class=hs-linenum> 48: </span>
<span class=hs-linenum> 49: </span><span class='hs-comment'>-- | Size of Ptr and ForeignPtr</span>
<span class=hs-linenum> 50: </span>
<span class=hs-linenum> 51: </span><span class='hs-comment'>-- measure plen  :: Ptr a -&gt; Int </span>
<span class=hs-linenum> 52: </span><span class='hs-comment'>-- measure fplen :: ForeignPtr a -&gt; Int </span>
<span class=hs-linenum> 53: </span>
<span class=hs-linenum> 54: </span>
<span class=hs-linenum> 55: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>PtrN</span> <span class='hs-varid'>a</span> <span class='hs-conid'>N</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span>        <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 56: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ForeignPtrN</span> <span class='hs-varid'>a</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>fplen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 57: </span>
<span class=hs-linenum> 58: </span><span class='hs-comment'>-- | Allocating Memory</span>
<span class=hs-linenum> 59: </span>
<span class=hs-linenum> 60: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>assume</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtrN</span> <span class='hs-varid'>a</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 61: </span>
<span class=hs-linenum> 62: </span><span class='hs-comment'>-- | Using a pointer</span>
<span class=hs-linenum> 63: </span>
<span class=hs-linenum> 64: </span><span class='hs-comment'>{- withForeignPtr :: fp:ForeignPtr a 
                  -&gt; (PtrN a (fplen fp) -&gt; IO b)  
                  -&gt; IO b             
-}</span>
<span class=hs-linenum> 68: </span>
<span class=hs-linenum> 69: </span><span class='hs-comment'>-- | Pointer Arithmetic</span>
<span class=hs-linenum> 70: </span>
<span class=hs-linenum> 71: </span><span class='hs-comment'>{- plusPtr :: p:Ptr a
           -&gt; o:{Nat|o &lt;= plen p}   -- in bounds
           -&gt; PtrN b (plen b - o)   -- remainder
-}</span>
<span class=hs-linenum> 75: </span>
<span class=hs-linenum> 76: </span><span class='hs-comment'>-- | Read and Write</span>
<span class=hs-linenum> 77: </span>
<span class=hs-linenum> 78: </span><span class='hs-comment'>{- peek :: {v:Ptr a | 0 &lt; plen v} -&gt; IO a  
   poke :: {v:Ptr a | 0 &lt; plen v} -&gt; a -&gt; IO ()  
 -}</span>
<span class=hs-linenum> 81: </span>
<span class=hs-linenum> 82: </span><span class='hs-comment'>-- | Example: Preventing Overflows e.g. writing 5 or 50 zeros?</span>
<span class=hs-linenum> 83: </span>
<span class=hs-linenum> 84: </span><a class=annot href="#"><span class=annottext>forall a. (IO (ForeignPtr a))</span><span class='hs-definition'>zero4'</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>(ForeignPtr a)</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr a) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>mallocForeignPtrBytes</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (4  :  int)}</span><span class='hs-num'>4</span></a>
<span class=hs-linenum> 85: </span>            <a class=annot href="#"><span class=annottext>x1:(ForeignPtr a)
-&gt; ({v : (Ptr a) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v} -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v} -&gt; (IO ()))
 -&gt; (IO ()))
-&gt; ({v : (Ptr a) | fplen fp == plen v &amp;&amp; zero &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr a) | fplen fp == plen VV &amp;&amp; zero &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum> 86: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 87: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 88: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 89: </span>              <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; fplen fp == plen v &amp;&amp; zero &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a></span><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == zero}</span><span class='hs-varid'>zero</span></a> 
<span class=hs-linenum> 90: </span>            <a class=annot href="#"><span class=annottext>(ForeignPtr a) -&gt; (IO (ForeignPtr a))</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr a) | v == fp}</span><span class='hs-varid'>fp</span></a>
<span class=hs-linenum> 91: </span>        <span class='hs-keyword'>where</span>
<span class=hs-linenum> 92: </span>            <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>zero</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-num'>0</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum> 93: </span>
<span class=hs-linenum> 94: </span>
<span class=hs-linenum> 95: </span>
<span class=hs-linenum> 96: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 97: </span><span class='hs-comment'>-- | 2. ByteString API -------------------------------------------------</span>
<span class=hs-linenum> 98: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 99: </span>
<span class=hs-linenum>100: </span><span class='hs-keyword'>data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-layout'>{</span>
<span class=hs-linenum>101: </span>    <a class=annot href="#"><span class=annottext>ByteString -&gt; (ForeignPtr Word8)</span><span class='hs-varid'>bPtr</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>102: </span>  <span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>ByteString -&gt; Int</span><span class='hs-varid'>bOff</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<span class=hs-linenum>103: </span>  <span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>ByteString -&gt; Int</span><span class='hs-varid'>bLen</span></a> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<span class=hs-linenum>104: </span>  <span class='hs-layout'>}</span>
<span class=hs-linenum>105: </span>
<span class=hs-linenum>106: </span>
<span class=hs-linenum>107: </span><span class='hs-comment'>-- | Refined Type, with invariants</span>
<span class=hs-linenum>108: </span>
<span class=hs-linenum>109: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-layout'>{</span>
<span class=hs-linenum>110: </span>      <span class='hs-varid'>bPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>111: </span>    <span class='hs-layout'>,</span> <span class='hs-varid'>bOff</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span>        <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>bPtr</span><span class='hs-layout'>}</span>
<span class=hs-linenum>112: </span>    <span class='hs-layout'>,</span> <span class='hs-varid'>bLen</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bOff</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>bPtr</span><span class='hs-layout'>}</span>
<span class=hs-linenum>113: </span>    <span class='hs-layout'>}</span>
<span class=hs-linenum>114: </span>
<span class=hs-linenum>115: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>116: </span>
<span class=hs-linenum>117: </span><span class='hs-comment'>-- | Some useful abbreviations</span>
<span class=hs-linenum>118: </span>
<span class=hs-linenum>119: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringN</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>120: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>StringN</span> <span class='hs-conid'>N</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>String</span>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>121: </span>
<span class=hs-linenum>122: </span><span class='hs-comment'>-- | Legal Bytestrings </span>
<span class=hs-linenum>123: </span>
<span class=hs-linenum>124: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>good1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-num'>5</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>125: </span><a class=annot href="#"><span class=annottext>(IO {v : ByteString | bLen v == 5})</span><span class='hs-definition'>good1</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>mallocForeignPtrBytes</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a>
<span class=hs-linenum>126: </span>           <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty}
-&gt; (IO {v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty})</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>({v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty}
 -&gt; (IO {v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty}))
-&gt; {v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty}
-&gt; (IO {v : ByteString | bLen v == 5 &amp;&amp; v /= Memory.empty})</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a>
<span class=hs-linenum>127: </span>
<span class=hs-linenum>128: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>good2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>129: </span><a class=annot href="#"><span class=annottext>(IO {v : ByteString | bLen v == 3})</span><span class='hs-definition'>good2</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>mallocForeignPtrBytes</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (5  :  int)}</span><span class='hs-num'>5</span></a>
<span class=hs-linenum>130: </span>           <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty}
-&gt; (IO {v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty})</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>({v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty}
 -&gt; (IO {v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty}))
-&gt; {v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty}
-&gt; (IO {v : ByteString | bLen v == 3 &amp;&amp; v /= Memory.empty})</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a>
<span class=hs-linenum>131: </span>
<span class=hs-linenum>132: </span><span class='hs-comment'>-- | Illegal Bytestrings </span>
<span class=hs-linenum>133: </span>
<span class=hs-linenum>134: </span><a class=annot href="#"><span class=annottext>(IO ByteString)</span><span class='hs-definition'>bad1</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>mallocForeignPtrBytes</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a> 
<span class=hs-linenum>135: </span>          <a class=annot href="#"><span class=annottext>ByteString -&gt; (IO ByteString)</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>(ByteString -&gt; (IO ByteString)) -&gt; ByteString -&gt; (IO ByteString)</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (10  :  int)}</span><span class='hs-num'>10</span></a></span> 
<span class=hs-linenum>136: </span>
<span class=hs-linenum>137: </span><a class=annot href="#"><span class=annottext>(IO ByteString)</span><span class='hs-definition'>bad2</span></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | VV /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>mallocForeignPtrBytes</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (3  :  int)}</span><span class='hs-num'>3</span></a>
<span class=hs-linenum>138: </span>          <a class=annot href="#"><span class=annottext>ByteString -&gt; (IO ByteString)</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>(ByteString -&gt; (IO ByteString)) -&gt; ByteString -&gt; (IO ByteString)</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; v /= Memory.nullForeignPtr}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (2  :  int)}</span><span class='hs-num'>2</span></a></span>
<span class=hs-linenum>139: </span>
<span class=hs-linenum>140: </span>
<span class=hs-linenum>141: </span>
<span class=hs-linenum>142: </span><span class='hs-comment'>-- | ByteString API: `create`</span>
<span class=hs-linenum>143: </span>
<span class=hs-linenum>144: </span><span class='hs-definition'>create</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>145: </span>
<span class=hs-linenum>146: </span><a class=annot href="#"><span class=annottext>Int -&gt; ((Ptr Word8) -&gt; (IO ())) -&gt; ByteString</span><span class='hs-definition'>create</span></a> <a class=annot href="#"><span class=annottext>Int</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>(Ptr Word8) -&gt; (IO ())</span><span class='hs-varid'>fill</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(IO ByteString) -&gt; ByteString</span><span class='hs-varid'>unsafePerformIO</span></a> <a class=annot href="#"><span class=annottext>((IO ByteString) -&gt; ByteString) -&gt; (IO ByteString) -&gt; ByteString</span><span class='hs-varop'>$</span></a> <span class='hs-keyword'>do</span>
<span class=hs-linenum>147: </span>  <a class=annot href="#"><span class=annottext>{VV : (ForeignPtr Word8) | fplen VV == n}</span><span class='hs-varid'>fp</span></a>  <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>mallocForeignPtrBytes</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == n}</span><span class='hs-varid'>n</span></a></span>
<span class=hs-linenum>148: </span>  <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; fplen v == n}</span><span class='hs-varid'>fp</span></a> <a class=annot href="#"><span class=annottext>(Ptr Word8) -&gt; (IO ())</span><span class='hs-varid'>fill</span></a> 
<span class=hs-linenum>149: </span>  <a class=annot href="#"><span class=annottext>ByteString -&gt; (IO ByteString)</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>(ByteString -&gt; (IO ByteString)) -&gt; ByteString -&gt; (IO ByteString)</span><span class='hs-varop'>$!</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == fp &amp;&amp; fplen v == n}</span><span class='hs-varid'>fp</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a></span> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == n}</span><span class='hs-varid'>n</span></a></span>
<span class=hs-linenum>150: </span>
<span class=hs-linenum>151: </span>
<span class=hs-linenum>152: </span><span class='hs-comment'>-- Yikes, there is an error! How to fix?</span>
<span class=hs-linenum>153: </span>
<span class=hs-linenum>154: </span><span class='hs-comment'>-- | ByteStringN API: `unsafeTake`</span>
<span class=hs-linenum>155: </span>
<span class=hs-linenum>156: </span><a class=annot href="#"><span class=annottext>Int -&gt; ByteString -&gt; ByteString</span><span class='hs-definition'>unsafeTake</span></a> <a class=annot href="#"><span class=annottext>Int</span><span class='hs-varid'>n</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen x}</span><span class='hs-varid'>s</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == n}</span><span class='hs-varid'>n</span></a></span>
<span class=hs-linenum>157: </span>
<span class=hs-linenum>158: </span><span class='hs-comment'>-- Wow, thats super fast. O(1)! But how to fix the error?</span>
<span class=hs-linenum>159: </span>
<span class=hs-linenum>160: </span><span class='hs-comment'>-- | ByteString API: `pack`</span>
<span class=hs-linenum>161: </span>
<span class=hs-linenum>162: </span><span class='hs-definition'>pack</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>163: </span><a class=annot href="#"><span class=annottext>[Char] -&gt; ByteString</span><span class='hs-definition'>pack</span></a> <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>str</span></a>      <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Int -&gt; ((Ptr Word8) -&gt; (IO ())) -&gt; ByteString</span><span class='hs-varid'>create</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v == len str}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>(((Ptr Word8) -&gt; (IO ())) -&gt; ByteString)
-&gt; ((Ptr Word8) -&gt; (IO ())) -&gt; ByteString</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>(Ptr Word8) -&gt; (IO ())</span><span class='hs-keyglyph'>\</span></a><a class=annot href="#"><span class=annottext>(Ptr Word8)</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>(Ptr Word8)
-&gt; {v : [Word8] | len v == len str &amp;&amp; len v &gt;= 0} -&gt; (IO ())</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : [Word8] | v == xs &amp;&amp; len v == len str &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>164: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>165: </span>  <a class=annot href="#"><span class=annottext>{v : Int | v == len str}</span><span class='hs-varid'>n</span></a>           <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:[Char] -&gt; {v : Int | v == len x1}</span><span class='hs-varid'>length</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == str &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>str</span></a>
<span class=hs-linenum>166: </span>  <a class=annot href="#"><span class=annottext>{v : [Word8] | len v == len str}</span><span class='hs-varid'>xs</span></a>          <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(Char -&gt; Word8) -&gt; x3:[Char] -&gt; {v : [Word8] | len v == len x3}</span><span class='hs-varid'>map</span></a> <a class=annot href="#"><span class=annottext>Char -&gt; Word8</span><span class='hs-varid'>c2w</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == str &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>str</span></a>
<span class=hs-linenum>167: </span>  <a class=annot href="#"><span class=annottext>forall a.
(Storable [Bivariant]
[] a) =&gt;
(Ptr a) -&gt; {VV : [a] | len VV == len str &amp;&amp; len VV &gt;= 0} -&gt; (IO ())</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>(Ptr a)</span><span class='hs-varid'>p</span></a> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | 0 &lt; plen v} -&gt; a -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p}</span><span class='hs-varid'>p</span></a></span> <a class=annot href="#"><span class=annottext>{VV : a | VV == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>(IO ()) -&gt; (IO ()) -&gt; (IO ())</span><span class='hs-varop'>&gt;&gt;</span></a> <a class=annot href="#"><span class=annottext>(Ptr a) -&gt; {VV : [a] | len VV &gt;= 0 &amp;&amp; len VV &lt;= len str} -&gt; (IO ())</span><span class='hs-varid'>go</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:{v : (Ptr a) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr a) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>plusPtr</span></a> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p}</span><span class='hs-varid'>p</span></a></span> <span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a></span><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : [a] | v == xs &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>168: </span>  <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>() -&gt; (IO ())</span><span class='hs-varid'>return</span></a>  <a class=annot href="#"><span class=annottext>{v : () | v == GHC.Tuple.()}</span><span class='hs-conid'>()</span></a>
<span class=hs-linenum>169: </span>
<span class=hs-linenum>170: </span><span class='hs-comment'>-- Hmm. How to fix the error?</span>
<span class=hs-linenum>171: </span>
<span class=hs-linenum>172: </span>
<span class=hs-linenum>173: </span>
<span class=hs-linenum>174: </span><span class='hs-comment'>-- | ByteString API: `unpack` </span>
<span class=hs-linenum>175: </span>
<span class=hs-linenum>176: </span>
<span class=hs-linenum>177: </span>
<span class=hs-linenum>178: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>Unpack</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-varid'>int</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>len</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>len</span> <span class='hs-varid'>acc</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>179: </span>
<span class=hs-linenum>180: </span><span class='hs-definition'>unpack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> 
<span class=hs-linenum>181: </span><a class=annot href="#"><span class=annottext>ByteString -&gt; [Char]</span><span class='hs-definition'>unpack</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>forall a &lt;p :: a a -&gt; Prop&gt;.
{v : [a]&lt;\x5 VV -&gt; p x5&gt; | null v &lt;=&gt; true &amp;&amp; len v == 0 &amp;&amp; bLens v == 0}</span><span class='hs-conid'>[]</span></a>
<span class=hs-linenum>182: </span><span class='hs-definition'>unpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(IO [Char]) -&gt; [Char]</span><span class='hs-varid'>unsafePerformIO</span></a> <a class=annot href="#"><span class=annottext>((IO [Char]) -&gt; [Char]) -&gt; (IO [Char]) -&gt; [Char]</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO [Char]))
-&gt; (IO [Char])</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>(ForeignPtr Word8)</span><span class='hs-varid'>ps</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr Word8) | 0 &lt;= plen v} -&gt; (IO [Char])) -&gt; (IO [Char]))
-&gt; ({v : (Ptr Word8) | 0 &lt;= plen v} -&gt; (IO [Char])) -&gt; (IO [Char])</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | 0 &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>183: </span>   <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; {v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen x1}
-&gt; {v : [Char] | len v &gt;= 0}
-&gt; (IO [Char])</span><span class='hs-varid'>go</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>s</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>l</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 - x2}</span><span class='hs-comment'>-</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span>  <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; true &amp;&amp; len v == 0 &amp;&amp; bLens v == 0 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-conid'>[]</span></a>
<span class=hs-linenum>184: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>185: </span>   <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; {v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen x1}
-&gt; {v : [Char] | len v &gt;= 0}
-&gt; (IO [Char])</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | 0 &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-num'>0</span> <a class=annot href="#"><span class=annottext>{VV : [Char] | len VV &gt;= 0}</span><span class='hs-varid'>acc</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt; plen v}
-&gt; (IO {v : Word8 | v == deref x1})</span><span class='hs-varid'>peek</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>(IO Word8) -&gt; (Word8 -&gt; (IO [Char])) -&gt; (IO [Char])</span><span class='hs-varop'>&gt;&gt;=</span></a> <a class=annot href="#"><span class=annottext>Word8 -&gt; (IO [Char])</span><span class='hs-keyglyph'>\</span></a><a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>e</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>[Char] -&gt; (IO [Char])</span><span class='hs-varid'>return</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>Word8 -&gt; Char</span><span class='hs-varid'>w2c</span></a> <a class=annot href="#"><span class=annottext>{v : Word8 | v == e}</span><span class='hs-varid'>e</span></a> <a class=annot href="#"><span class=annottext>x1:Char
-&gt; x2:[Char]
-&gt; {v : [Char] | null v &lt;=&gt; false &amp;&amp; xListSelector v == x1 &amp;&amp; len v == 1 + len x2 &amp;&amp; bLens v == bLen x1 + bLens x2 &amp;&amp; xsListSelector v == x2}</span><span class='hs-conop'>:</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == acc &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>acc</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>186: </span>   <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt; plen v}
-&gt; (IO {v : Word8 | v == deref x1})</span><span class='hs-varid'>peek</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen p}</span><span class='hs-varid'>n</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>(IO Word8) -&gt; (Word8 -&gt; (IO [Char])) -&gt; (IO [Char])</span><span class='hs-varop'>&gt;&gt;=</span></a> <a class=annot href="#"><span class=annottext>Word8 -&gt; (IO [Char])</span><span class='hs-keyglyph'>\</span></a><a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>e</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>x1:{VV : (Ptr Word8) | 0 &lt;= plen VV}
-&gt; {VV : Int | VV &gt;= 0 &amp;&amp; VV &lt;= plen x1}
-&gt; {VV : [Char] | len VV &gt;= 0}
-&gt; (IO [Char])</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0 &amp;&amp; v &lt;= plen p}</span><span class='hs-varid'>n</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 - x2}</span><span class='hs-comment'>-</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>Word8 -&gt; Char</span><span class='hs-varid'>w2c</span></a> <a class=annot href="#"><span class=annottext>{v : Word8 | v == e}</span><span class='hs-varid'>e</span></a> <a class=annot href="#"><span class=annottext>x1:Char
-&gt; x2:[Char]
-&gt; {v : [Char] | null v &lt;=&gt; false &amp;&amp; xListSelector v == x1 &amp;&amp; len v == 1 + len x2 &amp;&amp; bLens v == bLen x1 + bLens x2 &amp;&amp; xsListSelector v == x2}</span><span class='hs-conop'>:</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == acc &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>acc</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>187: </span>
<span class=hs-linenum>188: </span>
<span class=hs-linenum>189: </span>
<span class=hs-linenum>190: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>191: </span><span class='hs-comment'>-- | 3. Application API (Heartbleed no more!) --------------------------</span>
<span class=hs-linenum>192: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>193: </span>
<span class=hs-linenum>194: </span><span class='hs-definition'>chop</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> 
<span class=hs-linenum>195: </span><a class=annot href="#"><span class=annottext>[Char] -&gt; Int -&gt; [Char]</span><span class='hs-definition'>chop</span></a> <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>s</span></a> <a class=annot href="#"><span class=annottext>Int</span><span class='hs-varid'>n</span></a> <span class='hs-keyglyph'>=</span>  <a class=annot href="#"><span class=annottext>{v : [Char] | v == s' &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>s'</span></a>
<span class=hs-linenum>196: </span>  <span class='hs-keyword'>where</span> 
<span class=hs-linenum>197: </span>    <a class=annot href="#"><span class=annottext>ByteString</span><span class='hs-varid'>b</span></a>    <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>[Char] -&gt; ByteString</span><span class='hs-varid'>pack</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | v == s &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>s</span></a>          <span class='hs-comment'>-- down to low-level</span>
<span class=hs-linenum>198: </span>    <a class=annot href="#"><span class=annottext>ByteString</span><span class='hs-varid'>b'</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Int -&gt; ByteString -&gt; ByteString</span><span class='hs-varid'>unsafeTake</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == b &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>b</span></a>  <span class='hs-comment'>-- grab n chars</span>
<span class=hs-linenum>199: </span>    <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>s'</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>ByteString -&gt; [Char]</span><span class='hs-varid'>unpack</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == b' &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>b'</span></a>       <span class='hs-comment'>-- up to high-level</span>
<span class=hs-linenum>200: </span>
<span class=hs-linenum>201: </span><span class='hs-comment'>-- Whats the problem?</span>
<span class=hs-linenum>202: </span>
<span class=hs-linenum>203: </span>
<span class=hs-linenum>204: </span>
<span class=hs-linenum>205: </span>
<span class=hs-linenum>206: </span>
<span class=hs-linenum>207: </span><span class='hs-comment'>-- | "HeartBleed" no more</span>
<span class=hs-linenum>208: </span>
<span class=hs-linenum>209: </span><a class=annot href="#"><span class=annottext>[[Char]]</span><span class='hs-definition'>demo</span></a>     <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : [[Char]] | null v &lt;=&gt; false &amp;&amp; xListSelector v == ex30 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-keyglyph'>[</span></a><a class=annot href="#"><span class=annottext>{v : [Char] | v == ex6 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex6</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>{v : [Char] | v == ex30 &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex30</span></a><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>210: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>211: </span>    <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false}</span><span class='hs-varid'>ex</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false}</span><span class='hs-keyglyph'>[</span></a><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'R'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'a'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'n'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'j'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'i'</span></a><span class='hs-layout'>,</span><a class=annot href="#"><span class=annottext>Char</span><span class='hs-chr'>'t'</span></a><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>212: </span>    <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>ex6</span></a>  <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>[Char] -&gt; Int -&gt; [Char]</span><span class='hs-varid'>chop</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false &amp;&amp; v == ex &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (6  :  int)}</span><span class='hs-num'>6</span></a>  <span class='hs-comment'>-- ok</span>
<span class=hs-linenum>213: </span>    <a class=annot href="#"><span class=annottext>[Char]</span><span class='hs-varid'>ex30</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>[Char] -&gt; Int -&gt; [Char]</span><span class='hs-varid'>chop</span></a> <a class=annot href="#"><span class=annottext>{v : [Char] | null v &lt;=&gt; false &amp;&amp; v == ex &amp;&amp; len v &gt;= 0 &amp;&amp; bLens v &gt;= 0}</span><span class='hs-varid'>ex</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (30  :  int)}</span><span class='hs-num'>30</span></a> <span class='hs-comment'>-- out of bounds</span>
<span class=hs-linenum>214: </span>
<span class=hs-linenum>215: </span>
<span class=hs-linenum>216: </span><span class='hs-comment'>-- "Bleeding" `chop ex 30` *rejected* by compiler</span>
<span class=hs-linenum>217: </span>
<span class=hs-linenum>218: </span>
<span class=hs-linenum>219: </span>
<span class=hs-linenum>220: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>221: </span><span class='hs-comment'>-- | 3. Bonus Material -------------------------------------------------</span>
<span class=hs-linenum>222: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>223: </span>
<span class=hs-linenum>224: </span><span class='hs-comment'>-- | `group` ing ByteStrings </span>
<span class=hs-linenum>225: </span>
<span class=hs-linenum>226: </span><span class='hs-comment'>{- How shall we type `group` where

     group "foobaaar"

   returns

     ["f","oo", "b", "aaa", "r"]

-}</span>
<span class=hs-linenum>235: </span>
<span class=hs-linenum>236: </span><span class='hs-comment'>-- | An alias for NON-EMPTY ByteStrings</span>
<span class=hs-linenum>237: </span>    
<span class=hs-linenum>238: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringNE</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>239: </span>
<span class=hs-linenum>240: </span><span class='hs-comment'>-- | A measure for the sum of sizes of a LIST of ByteStrings</span>
<span class=hs-linenum>241: </span>    
<span class=hs-linenum>242: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>measure</span> <span class='hs-varid'>bLens</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<span class=hs-linenum>243: </span>    <span class='hs-varid'>bLens</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<span class=hs-linenum>244: </span>    <span class='hs-varid'>bLens</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bLen</span> <span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bLens</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<span class=hs-linenum>245: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>246: </span>
<span class=hs-linenum>247: </span><span class='hs-comment'>-- | @group@</span>
<span class=hs-linenum>248: </span>    
<span class=hs-linenum>249: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>group</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteStringNE</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>| bLens v = bLen b}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>250: </span><a class=annot href="#"><span class=annottext>x1:ByteString
-&gt; {v : [{v : ByteString | bLen v &gt; 0}] | bLens v == bLen x1}</span><span class='hs-definition'>group</span></a> <a class=annot href="#"><span class=annottext>ByteString</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>251: </span>    <span class='hs-keyglyph'>|</span> <a class=annot href="#"><span class=annottext>x1:ByteString -&gt; {v : Bool | Prop v &lt;=&gt; bLen x1 == 0}</span><span class='hs-varid'>null</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a>   <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>forall a &lt;p :: a a -&gt; Prop&gt;.
{v : [a]&lt;\x5 VV -&gt; p x5&gt; | null v &lt;=&gt; true &amp;&amp; len v == 0 &amp;&amp; bLens v == 0}</span><span class='hs-conid'>[]</span></a>
<span class=hs-linenum>252: </span>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>y</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : ByteString | bLen v &gt; 0} -&gt; Word8</span><span class='hs-varid'>unsafeHead</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a>
<span class=hs-linenum>253: </span>                      <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{VV : ByteString | VV == ys &amp;&amp; bLen Memory.empty + bLen VV == bLen ys &amp;&amp; VV /= xs}</span><span class='hs-varid'>ys</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>{VV : ByteString | VV == zs &amp;&amp; bLen Memory.empty + bLen VV == bLen zs &amp;&amp; VV /= xs}</span><span class='hs-varid'>zs</span></a><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>Word8
-&gt; x2:ByteString
-&gt; (ByteString, ByteString)&lt;\x3 VV -&gt; bLen x3 + bLen v == bLen x2&gt;</span><span class='hs-varid'>spanByte</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : ByteString | bLen v &gt; 0} -&gt; Word8</span><span class='hs-varid'>unsafeHead</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:{v : ByteString | bLen v &gt; 0}
-&gt; {v : ByteString | bLen v == bLen x1 - 1}</span><span class='hs-varid'>unsafeTail</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>xs</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>254: </span>                  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Word8 | v == y}</span><span class='hs-varid'>y</span></a> <a class=annot href="#"><span class=annottext>Word8 -&gt; x2:ByteString -&gt; {v : ByteString | bLen v == 1 + bLen v}</span><span class='hs-varop'>`cons`</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == ys &amp;&amp; v == ys &amp;&amp; bLen Memory.empty + bLen v == bLen ys &amp;&amp; v /= xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ys</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>x1:{v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0}
-&gt; x2:[{v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0}]&lt;\_ VV -&gt; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;
-&gt; {v : [{v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0}]&lt;\_ VV -&gt; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt; | null v &lt;=&gt; false &amp;&amp; xListSelector v == x1 &amp;&amp; len v == 1 + len x2 &amp;&amp; bLens v == bLen x1 + bLens x2 &amp;&amp; xsListSelector v == x2}</span><span class='hs-conop'>:</span></a> <a class=annot href="#"><span class=annottext>x1:ByteString
-&gt; {v : [{v : ByteString | bLen v &gt; 0}] | bLens v == bLen x1}</span><span class='hs-varid'>group</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == zs &amp;&amp; v == zs &amp;&amp; bLen Memory.empty + bLen v == bLen zs &amp;&amp; v /= xs &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>zs</span></a>
<span class=hs-linenum>255: </span>
<span class=hs-linenum>256: </span>
<span class=hs-linenum>257: </span><span class='hs-comment'>-- | @spanByte@ does the heavy lifting</span>
<span class=hs-linenum>258: </span>
<span class=hs-linenum>259: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>spanByte</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringPair</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>260: </span><span class='hs-definition'>spanByte</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span>
<span class=hs-linenum>261: </span><a class=annot href="#"><span class=annottext>Word8
-&gt; x2:ByteString
-&gt; (ByteString, ByteString)&lt;\x12 VV -&gt; bLen x12 + bLen VV == bLen x2&gt;</span><span class='hs-definition'>spanByte</span></a> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>c</span></a> <a class=annot href="#"><span class=annottext>ByteString</span><span class='hs-varid'>ps</span></a><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(IO (ByteString, ByteString)) -&gt; (ByteString, ByteString)</span><span class='hs-varid'>unsafePerformIO</span></a> <a class=annot href="#"><span class=annottext>((IO (ByteString, ByteString)) -&gt; (ByteString, ByteString))
-&gt; (IO (ByteString, ByteString)) -&gt; (ByteString, ByteString)</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO (ByteString, ByteString)))
-&gt; (IO (ByteString, ByteString))</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; s &lt;= plen v &amp;&amp; l &lt;= plen v}
  -&gt; (IO (ByteString, ByteString)))
 -&gt; (IO (ByteString, ByteString)))
-&gt; ({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; s &lt;= plen v &amp;&amp; l &lt;= plen v}
    -&gt; (IO (ByteString, ByteString)))
-&gt; (IO (ByteString, ByteString))</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | fplen x == plen VV &amp;&amp; 0 &lt;= plen VV &amp;&amp; s &lt;= plen VV &amp;&amp; l &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>262: </span>    <a class=annot href="#"><span class=annottext>{v : (Ptr (Any *)) | l &lt;= plen v}
-&gt; {v : Int | v == 0 &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= s &amp;&amp; v &lt;= l}
-&gt; (IO (ByteString, ByteString))</span><span class='hs-varid'>go</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; s &lt;= plen v &amp;&amp; l &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr (Any *)) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen x}</span><span class='hs-varid'>s</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a>
<span class=hs-linenum>263: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>264: </span>    <a class=annot href="#"><span class=annottext>forall a.
{VV : (Ptr a) | l &lt;= plen VV}
-&gt; {VV : Int | VV == 0 &amp;&amp; VV &gt;= 0 &amp;&amp; VV &lt;= s &amp;&amp; VV &lt;= l}
-&gt; (IO (ByteString, ByteString))</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr a) | l &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{VV : Int | VV &gt;= 0 &amp;&amp; VV &lt;= l}</span><span class='hs-varid'>i</span></a> <span class='hs-keyglyph'>|</span> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &gt;= v}</span><span class='hs-varop'>&gt;=</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen x}</span><span class='hs-varid'>l</span></a>    <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(ByteString, ByteString)&lt;\x42 VV -&gt; v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen v == bLen x42 - i &amp;&amp; bLen v == bLen x42 - l &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps &amp;&amp; bLen ps + bLen v == bLen x42 &amp;&amp; bLen x42 + bLen v == bLen ps &amp;&amp; bLen x42 + bLen v == bLen x42&gt;
-&gt; (IO (ByteString, ByteString)&lt;\x42 VV -&gt; v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen v == bLen x42 - i &amp;&amp; bLen v == bLen x42 - l &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps &amp;&amp; bLen ps + bLen v == bLen x42 &amp;&amp; bLen x42 + bLen v == bLen ps &amp;&amp; bLen x42 + bLen v == bLen x42&gt;)</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>{v : (ByteString, {v : ByteString | v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps})&lt;\x21 VV -&gt; v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v == bLen ps - i &amp;&amp; bLen v == bLen ps - l &amp;&amp; bLen v == bLen x21 - i &amp;&amp; bLen v == bLen x21 - l &amp;&amp; bLen Memory.empty + bLen v == bLen Memory.empty &amp;&amp; bLen ps + bLen v == bLen ps &amp;&amp; bLen ps + bLen v == bLen x21 &amp;&amp; bLen x21 + bLen v == bLen ps &amp;&amp; bLen x21 + bLen v == bLen x21&gt; | x_Tuple22 v == Memory.empty &amp;&amp; snd v == Memory.empty}</span><span class='hs-layout'>(</span></a><a class=annot href="#"><span class=annottext>{v : ByteString | v == ps &amp;&amp; v == Memory.PS x s l &amp;&amp; bLen v == l &amp;&amp; bOff v == s &amp;&amp; bPtr v == x &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ps</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>{v : ByteString | v == Memory.empty &amp;&amp; bLen v == 0 &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>empty</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>265: </span>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>c'</span></a> <span class='hs-keyglyph'>&lt;-</span> <a class=annot href="#"><span class=annottext>p:(Ptr a) -&gt; {v : Int | v &lt; plen p &amp;&amp; 0 &lt;= v} -&gt; (IO Word8)</span><span class='hs-varid'>peekByteOff</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; l &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a>
<span class=hs-linenum>266: </span>                            <span class='hs-keyword'>if</span> <a class=annot href="#"><span class=annottext>{v : Word8 | v == c}</span><span class='hs-varid'>c</span></a> <a class=annot href="#"><span class=annottext>x1:Word8 -&gt; x2:Word8 -&gt; {v : Bool | Prop v &lt;=&gt; x1 /= v}</span><span class='hs-varop'>/=</span></a> <a class=annot href="#"><span class=annottext>{v : Word8 | v == c'}</span><span class='hs-varid'>c'</span></a>
<span class=hs-linenum>267: </span>                                <span class='hs-keyword'>then</span> <a class=annot href="#"><span class=annottext>(ByteString, ByteString)&lt;\_ VV -&gt; bLen v == bLen ps - i &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;
-&gt; (IO (ByteString, ByteString)&lt;\_ VV -&gt; bLen v == bLen ps - i &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;)</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>(ByteString, {v : ByteString | bLen v == bLen ps - i &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0})&lt;\_ VV -&gt; bLen v == bLen ps - i &amp;&amp; v /= Memory.empty &amp;&amp; bLen v &gt; 0&gt;</span><span class='hs-layout'>(</span></a><a class=annot href="#"><span class=annottext>Int -&gt; ByteString -&gt; ByteString</span><span class='hs-varid'>unsafeTake</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == ps &amp;&amp; v == Memory.PS x s l &amp;&amp; bLen v == l &amp;&amp; bOff v == s &amp;&amp; bPtr v == x &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ps</span></a><span class='hs-layout'>,</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; x2:{v : ByteString | x1 &lt;= bLen v}
-&gt; {v : ByteString | bLen v == bLen v - x1}</span><span class='hs-varid'>unsafeDrop</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a> <a class=annot href="#"><span class=annottext>{v : ByteString | v == ps &amp;&amp; v == Memory.PS x s l &amp;&amp; bLen v == l &amp;&amp; bOff v == s &amp;&amp; bPtr v == x &amp;&amp; bLen v &gt;= 0}</span><span class='hs-varid'>ps</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>268: </span>                                <span class='hs-keyword'>else</span> <a class=annot href="#"><span class=annottext>{VV : (Ptr a) | l &lt;= plen VV}
-&gt; {VV : Int | VV &gt;= 0 &amp;&amp; VV &lt;= l} -&gt; (IO (ByteString, ByteString))</span><span class='hs-varid'>go</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr a) | v == p &amp;&amp; l &lt;= plen v}</span><span class='hs-varid'>p</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == i &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= l}</span><span class='hs-varid'>i</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 + x2}</span><span class='hs-varop'>+</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>269: </span>
<span class=hs-linenum>270: </span><span class='hs-comment'>-- | Using the alias</span>
<span class=hs-linenum>271: </span>                            
<span class=hs-linenum>272: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringPair</span> <span class='hs-conid'>B</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span><span class='hs-varop'>&lt;</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x1</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>273: </span>       <span class='hs-varid'>bLen</span> <span class='hs-varid'>x1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bLen</span> <span class='hs-conid'>B</span><span class='hs-layout'>}</span><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>274: </span>
<span class=hs-linenum>275: </span>
<span class=hs-linenum>276: </span>
<span class=hs-linenum>277: </span>
<span class=hs-linenum>278: </span>
<span class=hs-linenum>279: </span>
<span class=hs-linenum>280: </span>
<span class=hs-linenum>281: </span>
<span class=hs-linenum>282: </span>
<span class=hs-linenum>283: </span>
<span class=hs-linenum>284: </span>
<span class=hs-linenum>285: </span><span class='hs-comment'>----------------------------------------------------------------------------</span>
<span class=hs-linenum>286: </span><span class='hs-comment'>-- | CHEAT AREA</span>
<span class=hs-linenum>287: </span><span class='hs-comment'>----------------------------------------------------------------------------</span>
<span class=hs-linenum>288: </span>
<span class=hs-linenum>289: </span><span class='hs-comment'>-- #START ERRORS 13</span>
<span class=hs-linenum>290: </span><span class='hs-comment'>-- #END   ERRORS 4 (zero4', bad1, bad2, ex30) </span>
<span class=hs-linenum>291: </span>                            
<span class=hs-linenum>292: </span><span class='hs-comment'>{- create     :: n:Nat -&gt; (PtrN Word8 n -&gt; IO ()) -&gt; ByteStringN n      @-}</span>
<span class=hs-linenum>293: </span><span class='hs-comment'>{- unsafeTake :: n:Nat -&gt; b:{ByteString | n &lt;= bLen b} -&gt; ByteStringN n @-}</span>
<span class=hs-linenum>294: </span><span class='hs-comment'>{- pack       :: s:String -&gt; ByteStringN (len s)                        @-}</span>
<span class=hs-linenum>295: </span><span class='hs-comment'>{- unpack     :: b:ByteString -&gt; {v:String | len v = bLen b}            @-}</span>
<span class=hs-linenum>296: </span><span class='hs-comment'>{- chop       :: s:String -&gt; n:{Nat | n &lt;= len s} -&gt; StringN n          @-}</span> 
<span class=hs-linenum>297: </span>
<span class=hs-linenum>298: </span>
<span class=hs-linenum>299: </span>
<span class=hs-linenum>300: </span>
<span class=hs-linenum>301: </span>
<span class=hs-linenum>302: </span>
<span class=hs-linenum>303: </span>
<span class=hs-linenum>304: </span>
<span class=hs-linenum>305: </span>
<span class=hs-linenum>306: </span>
<span class=hs-linenum>307: </span>
<span class=hs-linenum>308: </span>
<span class=hs-linenum>309: </span>
<span class=hs-linenum>310: </span>
<span class=hs-linenum>311: </span>
<span class=hs-linenum>312: </span>
<span class=hs-linenum>313: </span>
<span class=hs-linenum>314: </span>
<span class=hs-linenum>315: </span>
<span class=hs-linenum>316: </span>
<span class=hs-linenum>317: </span>
<span class=hs-linenum>318: </span>
<span class=hs-linenum>319: </span>
<span class=hs-linenum>320: </span>
<span class=hs-linenum>321: </span>
<span class=hs-linenum>322: </span>
<span class=hs-linenum>323: </span>
<span class=hs-linenum>324: </span><span class='hs-comment'>-----------------------------------------------------------------------</span>
<span class=hs-linenum>325: </span><span class='hs-comment'>-- | Helper Code (Stuff from BS benchmark, to make demo self-contained)</span>
<span class=hs-linenum>326: </span><span class='hs-comment'>-----------------------------------------------------------------------</span>
<span class=hs-linenum>327: </span>
<span class=hs-linenum>328: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeCreate</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrN</span> <span class='hs-conid'>Word8</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>329: </span><a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; ({VV : (Ptr Word8) | plen VV == x1 &amp;&amp; 0 &lt;= plen VV} -&gt; (IO ()))
-&gt; {v : ByteString | bLen v == x1}</span><span class='hs-definition'>unsafeCreate</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | plen VV == n &amp;&amp; 0 &lt;= plen VV} -&gt; (IO ())</span><span class='hs-varid'>f</span></a> <span class='hs-keyglyph'>=</span> <span class=hs-error><a class=annot href="#"><span class=annottext>Int -&gt; ((Ptr Word8) -&gt; (IO ())) -&gt; ByteString</span><span class='hs-varid'>create</span></a></span><span class=hs-error> </span><span class=hs-error><a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a></span><span class=hs-error> </span><span class=hs-error><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | plen v == n &amp;&amp; 0 &lt;= plen v} -&gt; (IO ())</span><span class='hs-varid'>f</span></a></span> <span class='hs-comment'>-- unsafePerformIO $ create n f</span>
<span class=hs-linenum>330: </span>
<span class=hs-linenum>331: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>invariant</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span>   <span class='hs-keyword'>| bLen  v &gt;= 0}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>332: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>invariant</span> <span class='hs-keyword'>{v:</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>| bLens v &gt;= 0}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>333: </span>
<span class=hs-linenum>334: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>PLLen</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>plen</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>335: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>ForeignPtrN</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-varid'>int</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>336: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>FPLenPLen</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>fp</span><span class='hs-conop'>:</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>337: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>PtrLen</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs</span><span class='hs-conop'>:</span><span class='hs-conid'>List</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>len</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>338: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>PlenEq</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span> <span class='hs-varid'>int</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>plen</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>339: </span>
<span class=hs-linenum>340: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) &gt; 0}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>341: </span>
<span class=hs-linenum>342: </span><span class='hs-definition'>unsafeHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>343: </span><a class=annot href="#"><span class=annottext>{v : ByteString | bLen v &gt; 0} -&gt; Word8</span><span class='hs-definition'>unsafeHead</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : Bool | Prop v} -&gt; Word8 -&gt; Word8</span><span class='hs-varid'>liquidAssert</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen x}</span><span class='hs-varid'>l</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &gt; v}</span><span class='hs-varop'>&gt;</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>(Word8 -&gt; Word8) -&gt; Word8 -&gt; Word8</span><span class='hs-varop'>$</span></a>
<span class=hs-linenum>344: </span>  <a class=annot href="#"><span class=annottext>(IO Word8) -&gt; Word8</span><span class='hs-varid'>unsafePerformIO</span></a>  <a class=annot href="#"><span class=annottext>((IO Word8) -&gt; Word8) -&gt; (IO Word8) -&gt; Word8</span><span class='hs-varop'>$</span></a>  <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO Word8))
-&gt; (IO Word8)</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}
  -&gt; (IO Word8))
 -&gt; (IO Word8))
-&gt; ({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}
    -&gt; (IO Word8))
-&gt; (IO Word8)</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}
-&gt; (IO Word8)</span><span class='hs-keyglyph'>\</span></a><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | fplen x == plen VV &amp;&amp; 0 &lt;= plen VV &amp;&amp; l &lt;= plen VV &amp;&amp; s &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>p:(Ptr Word8) -&gt; {v : Int | v &lt; plen p &amp;&amp; 0 &lt;= v} -&gt; (IO Word8)</span><span class='hs-varid'>peekByteOff</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen x}</span><span class='hs-varid'>s</span></a>
<span class=hs-linenum>345: </span>
<span class=hs-linenum>346: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeTail</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) &gt; 0}</span>
<span class=hs-linenum>347: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = (bLen b) - 1}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>348: </span><span class='hs-definition'>unsafeTail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>349: </span><a class=annot href="#"><span class=annottext>x1:{v : ByteString | bLen v &gt; 0}
-&gt; {v : ByteString | bLen v == bLen x1 - 1}</span><span class='hs-definition'>unsafeTail</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : Bool | Prop v} -&gt; ByteString -&gt; ByteString</span><span class='hs-varid'>liquidAssert</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen ps}</span><span class='hs-varid'>l</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &gt; v}</span><span class='hs-varop'>&gt;</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == ps}</span><span class='hs-varid'>ps</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen ps}</span><span class='hs-varid'>s</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 + x2}</span><span class='hs-varop'>+</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen ps}</span><span class='hs-varid'>l</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 - x2}</span><span class='hs-comment'>-</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>350: </span>
<span class=hs-linenum>351: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>null</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>Bool</span> <span class='hs-keyword'>| ((Prop v) &lt;=&gt; ((bLen b) = 0))}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>352: </span><span class='hs-definition'>null</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<span class=hs-linenum>353: </span><a class=annot href="#"><span class=annottext>x1:ByteString -&gt; {v : Bool | Prop v &lt;=&gt; bLen x1 == 0}</span><span class='hs-definition'>null</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : Bool | Prop v} -&gt; Bool -&gt; Bool</span><span class='hs-varid'>liquidAssert</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>l</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &gt;= v}</span><span class='hs-varop'>&gt;=</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>(Bool -&gt; Bool) -&gt; Bool -&gt; Bool</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>l</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &lt;= v}</span><span class='hs-varop'>&lt;=</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a>
<span class=hs-linenum>354: </span>
<span class=hs-linenum>355: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeDrop</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span>
<span class=hs-linenum>356: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-keyword'>{v:</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| n &lt;= (bLen v)}</span> 
<span class=hs-linenum>357: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = (bLen b) - n}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>358: </span><span class='hs-definition'>unsafeDrop</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>359: </span><a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; x2:{v : ByteString | x1 &lt;= bLen v}
-&gt; {v : ByteString | bLen v == bLen x2 - x1}</span><span class='hs-definition'>unsafeDrop</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v &gt;= 0}</span><span class='hs-varid'>n</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>{v : Bool | Prop v} -&gt; ByteString -&gt; ByteString</span><span class='hs-varid'>liquidAssert</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &lt;= v}</span><span class='hs-varop'>&lt;=</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>x1:Bool -&gt; x2:Bool -&gt; {v : Bool | Prop v &lt;=&gt; Prop x1 &amp;&amp; Prop v}</span><span class='hs-varop'>&amp;&amp;</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a> <a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Bool | Prop v &lt;=&gt; x1 &lt;= v}</span><span class='hs-varop'>&lt;=</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen x}</span><span class='hs-varid'>l</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == x}</span><span class='hs-varid'>x</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen x}</span><span class='hs-varid'>s</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 + x2}</span><span class='hs-varop'>+</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen x}</span><span class='hs-varid'>l</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 - x2}</span><span class='hs-comment'>-</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == n &amp;&amp; v &gt;= 0}</span><span class='hs-varid'>n</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>360: </span>
<span class=hs-linenum>361: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = 1 + (bLen b)}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>362: </span><span class='hs-definition'>cons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>363: </span><a class=annot href="#"><span class=annottext>Word8 -&gt; x2:ByteString -&gt; {v : ByteString | bLen v == 1 + bLen x2}</span><span class='hs-definition'>cons</span></a> <a class=annot href="#"><span class=annottext>Word8</span><span class='hs-varid'>c</span></a> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : Int | v &gt;= 0}
-&gt; ({v : (Ptr Word8) | plen v == x1 &amp;&amp; 0 &lt;= plen v} -&gt; (IO ()))
-&gt; {v : ByteString | bLen v == x1}</span><span class='hs-varid'>unsafeCreate</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen x}</span><span class='hs-varid'>l</span></a><a class=annot href="#"><span class=annottext>x1:Int -&gt; x2:Int -&gt; {v : Int | v == x1 + x2}</span><span class='hs-varop'>+</span></a><a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <a class=annot href="#"><span class=annottext>(({v : (Ptr Word8) | 0 &lt;= plen v &amp;&amp; l &lt;= plen v} -&gt; (IO ()))
 -&gt; {v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0 &amp;&amp; l &lt;= bLen v})
-&gt; ({v : (Ptr Word8) | 0 &lt;= plen v &amp;&amp; l &lt;= plen v} -&gt; (IO ()))
-&gt; {v : ByteString | v /= Memory.empty &amp;&amp; bLen v &gt; 0 &amp;&amp; l &lt;= bLen v}</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | 0 &lt;= plen VV &amp;&amp; l &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <span class='hs-keyglyph'>-&gt;</span> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; ({v : (Ptr Word8) | plen v == fplen x1 &amp;&amp; 0 &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varid'>withForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == x}</span><span class='hs-varid'>x</span></a> <a class=annot href="#"><span class=annottext>(({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}
  -&gt; (IO ()))
 -&gt; (IO ()))
-&gt; ({v : (Ptr Word8) | fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}
    -&gt; (IO ()))
-&gt; (IO ())</span><span class='hs-varop'>$</span></a> <span class='hs-keyglyph'>\</span><a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | fplen x == plen VV &amp;&amp; 0 &lt;= plen VV &amp;&amp; l &lt;= plen VV &amp;&amp; s &lt;= plen VV}</span><span class='hs-varid'>f</span></a> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>364: </span>        <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | 0 &lt; plen v} -&gt; Word8 -&gt; (IO ())</span><span class='hs-varid'>poke</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : Word8 | v == c}</span><span class='hs-varid'>c</span></a>
<span class=hs-linenum>365: </span>        <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; {v : CSize | v &lt;= plen x1 &amp;&amp; v &lt;= plen x2}
-&gt; (IO ())</span><span class='hs-varid'>memcpy</span></a> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (1  :  int)}</span><span class='hs-num'>1</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == f &amp;&amp; fplen x == plen v &amp;&amp; 0 &lt;= plen v &amp;&amp; l &lt;= plen v &amp;&amp; s &lt;= plen v}</span><span class='hs-varid'>f</span></a> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : Int | v &lt;= plen x1}
-&gt; {v : (Ptr Word8) | pbase v == pbase x1 &amp;&amp; plen v == plen x1 - x2 &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varop'>`plusPtr`</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == s &amp;&amp; v &gt;= 0 &amp;&amp; v &lt;= fplen x}</span><span class='hs-varid'>s</span></a><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><a class=annot href="#"><span class=annottext>x1:Int -&gt; {v : CSize | v == x1}</span><span class='hs-varid'>fromIntegral</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == l &amp;&amp; v &gt;= 0 &amp;&amp; v + s &lt;= fplen x}</span><span class='hs-varid'>l</span></a><span class='hs-layout'>)</span>
<span class=hs-linenum>366: </span>
<span class=hs-linenum>367: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>empty</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = 0}</span> <span class='hs-keyword'>@-}</span> 
<span class=hs-linenum>368: </span><span class='hs-definition'>empty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>369: </span><a class=annot href="#"><span class=annottext>{v : ByteString | bLen v == 0}</span><span class='hs-definition'>empty</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:(ForeignPtr Word8)
-&gt; x2:{v : Int | v &gt;= 0 &amp;&amp; v &lt;= fplen x1}
-&gt; x3:{v : Int | v &gt;= 0 &amp;&amp; v + x2 &lt;= fplen x1}
-&gt; {v : ByteString | bLen v == x3 &amp;&amp; bOff v == x2 &amp;&amp; bPtr v == x1}</span><span class='hs-conid'>PS</span></a> <a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | v == Memory.nullForeignPtr &amp;&amp; fplen v == 0}</span><span class='hs-varid'>nullForeignPtr</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a> <a class=annot href="#"><span class=annottext>{v : Int | v == (0  :  int)}</span><span class='hs-num'>0</span></a>
<span class=hs-linenum>370: </span>
<span class=hs-linenum>371: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>assume</span>
<span class=hs-linenum>372: </span>    <span class='hs-varid'>c_memcpy</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>dst</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>373: </span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>src</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span> 
<span class=hs-linenum>374: </span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>size</span><span class='hs-conop'>:</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>CSize</span> <span class='hs-keyword'>| (v &lt;= (plen src) &amp;&amp; v &lt;= (plen dst))}</span> 
<span class=hs-linenum>375: </span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>376: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>377: </span><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"string.h memcpy"</span> <span class='hs-varid'>c_memcpy</span>
<span class=hs-linenum>378: </span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>379: </span>
<span class=hs-linenum>380: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>memcpy</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>dst</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>381: </span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>src</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span> 
<span class=hs-linenum>382: </span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>size</span><span class='hs-conop'>:</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>CSize</span> <span class='hs-keyword'>| (v &lt;= (plen src) &amp;&amp; v &lt;= (plen dst))}</span> 
<span class=hs-linenum>383: </span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> 
<span class=hs-linenum>384: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>385: </span><span class='hs-definition'>memcpy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<span class=hs-linenum>386: </span><a class=annot href="#"><span class=annottext>x1:{VV : (Ptr Word8) | 0 &lt;= plen VV}
-&gt; x2:{VV : (Ptr Word8) | 0 &lt;= plen VV}
-&gt; {v : CSize | v &lt;= plen x1 &amp;&amp; v &lt;= plen x2}
-&gt; (IO ())</span><span class='hs-definition'>memcpy</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | 0 &lt;= plen VV}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{VV : (Ptr Word8) | 0 &lt;= plen VV}</span><span class='hs-varid'>q</span></a> <a class=annot href="#"><span class=annottext>{v : CSize | v &lt;= plen q &amp;&amp; v &lt;= plen p}</span><span class='hs-varid'>s</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>x1:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; x2:{v : (Ptr Word8) | 0 &lt;= plen v}
-&gt; {v : CSize | v &lt;= plen x1 &amp;&amp; v &lt;= plen x2}
-&gt; (IO (Ptr Word8))</span><span class='hs-varid'>c_memcpy</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == p &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>p</span></a> <a class=annot href="#"><span class=annottext>{v : (Ptr Word8) | v == q &amp;&amp; 0 &lt;= plen v}</span><span class='hs-varid'>q</span></a> <a class=annot href="#"><span class=annottext>{v : CSize | v == s &amp;&amp; v &lt;= plen q &amp;&amp; v &lt;= plen p}</span><span class='hs-varid'>s</span></a> <a class=annot href="#"><span class=annottext>(IO (Ptr Word8)) -&gt; (IO ()) -&gt; (IO ())</span><span class='hs-varop'>&gt;&gt;</span></a> <a class=annot href="#"><span class=annottext>() -&gt; (IO ())</span><span class='hs-varid'>return</span></a> <a class=annot href="#"><span class=annottext>{v : () | v == GHC.Tuple.()}</span><span class='hs-conid'>()</span></a>
<span class=hs-linenum>387: </span>
<span class=hs-linenum>388: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>assume</span> <span class='hs-varid'>nullForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>{v:</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyword'>| (fplen v) = 0}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>389: </span><span class='hs-definition'>nullForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>390: </span><a class=annot href="#"><span class=annottext>{v : (ForeignPtr Word8) | fplen v == 0}</span><span class='hs-definition'>nullForeignPtr</span></a> <span class='hs-keyglyph'>=</span> <a class=annot href="#"><span class=annottext>(IO (ForeignPtr Word8)) -&gt; (ForeignPtr Word8)</span><span class='hs-varid'>unsafePerformIO</span></a> <a class=annot href="#"><span class=annottext>((IO (ForeignPtr Word8)) -&gt; (ForeignPtr Word8))
-&gt; (IO (ForeignPtr Word8)) -&gt; (ForeignPtr Word8)</span><span class='hs-varop'>$</span></a> <a class=annot href="#"><span class=annottext>x1:(Ptr Word8)
-&gt; (IO {v : (ForeignPtr Word8) | fplen v == plen x1 &amp;&amp; 0 &lt;= fplen v})</span><span class='hs-varid'>newForeignPtr_</span></a> <a class=annot href="#"><span class=annottext>(Ptr Word8)</span><span class='hs-varid'>nullPtr</span></a>
<span class=hs-linenum>391: </span><span class='hs-comment'>{-# NOINLINE nullForeignPtr #-}</span>
<span class=hs-linenum>392: </span>
</pre>
<head>
<link type='text/css' rel='stylesheet' href='liquid.css' />
</head>
