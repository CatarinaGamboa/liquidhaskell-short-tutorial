<pre><span class=hs-linenum>  3: </span>
<span class=hs-linenum>  4: </span><span class='hs-comment'>{-# LANGUAGE ForeignFunctionInterface #-}</span>
<span class=hs-linenum>  5: </span>
<span class=hs-linenum>  6: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--no-termination"</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  7: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--short-names"</span>    <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  8: </span><span class='hs-keyword'>{-@</span> <span class='hs-conid'>LIQUID</span> <span class='hs-str'>"--diffcheck"</span>     <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>  9: </span>
<span class=hs-linenum> 10: </span><span class='hs-keyword'>module</span> <span class='hs-conid'>Memory</span> <span class='hs-keyword'>where</span>
<span class=hs-linenum> 11: </span>
<span class=hs-linenum> 12: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 13: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<span class=hs-linenum> 14: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span>
<span class=hs-linenum> 15: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>C</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<span class=hs-linenum> 16: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>ForeignPtr</span>
<span class=hs-linenum> 17: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Ptr</span>
<span class=hs-linenum> 18: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span><span class='hs-varop'>.</span><span class='hs-conid'>Storable</span>
<span class=hs-linenum> 19: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span>
<span class=hs-linenum> 20: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>Internal</span> <span class='hs-layout'>(</span><span class='hs-varid'>c2w</span><span class='hs-layout'>,</span> <span class='hs-varid'>w2c</span><span class='hs-layout'>)</span>
<span class=hs-linenum> 21: </span><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Liquid</span><span class='hs-varop'>.</span><span class='hs-conid'>Prelude</span>
<span class=hs-linenum> 22: </span>
<span class=hs-linenum> 23: </span>
<span class=hs-linenum> 24: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 25: </span><span class='hs-comment'>-- | 1. Low-level Pointer API  -----------------------------------------</span>
<span class=hs-linenum> 26: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 27: </span>
<span class=hs-linenum> 28: </span><span class='hs-comment'>-- | Create a buffer of size 4 and initialize it with zeros</span>
<span class=hs-linenum> 29: </span>
<span class=hs-linenum> 30: </span><span class='hs-definition'>zero4</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-num'>4</span>
<span class=hs-linenum> 31: </span>            <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum> 32: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 33: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 34: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 35: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 36: </span>            <span class='hs-varid'>return</span> <span class='hs-varid'>fp</span>
<span class=hs-linenum> 37: </span>        <span class='hs-keyword'>where</span>
<span class=hs-linenum> 38: </span>            <span class='hs-varid'>zero</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum> 39: </span>
<span class=hs-linenum> 40: </span><span class='hs-comment'>-- But whats to prevent an overflow, e.g. writing to offset 5 or 50?</span>
<span class=hs-linenum> 41: </span>            
<span class=hs-linenum> 42: </span>
<span class=hs-linenum> 43: </span>
<span class=hs-linenum> 44: </span><span class='hs-comment'>-- | Types for Pointers</span>
<span class=hs-linenum> 45: </span>
<span class=hs-linenum> 46: </span><span class='hs-comment'>-- data Ptr a         </span>
<span class=hs-linenum> 47: </span><span class='hs-comment'>-- data ForeignPtr a </span>
<span class=hs-linenum> 48: </span>
<span class=hs-linenum> 49: </span><span class='hs-comment'>-- | Size of Ptr and ForeignPtr</span>
<span class=hs-linenum> 50: </span>
<span class=hs-linenum> 51: </span><span class='hs-comment'>-- measure plen  :: Ptr a -&gt; Int </span>
<span class=hs-linenum> 52: </span><span class='hs-comment'>-- measure fplen :: ForeignPtr a -&gt; Int </span>
<span class=hs-linenum> 53: </span>
<span class=hs-linenum> 54: </span>
<span class=hs-linenum> 55: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>PtrN</span> <span class='hs-varid'>a</span> <span class='hs-conid'>N</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span>        <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 56: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ForeignPtrN</span> <span class='hs-varid'>a</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>fplen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 57: </span>
<span class=hs-linenum> 58: </span><span class='hs-comment'>-- | Allocating Memory</span>
<span class=hs-linenum> 59: </span>
<span class=hs-linenum> 60: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>assume</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForeignPtrN</span> <span class='hs-varid'>a</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum> 61: </span>
<span class=hs-linenum> 62: </span><span class='hs-comment'>-- | Using a pointer</span>
<span class=hs-linenum> 63: </span>
<span class=hs-linenum> 64: </span><span class='hs-comment'>{- withForeignPtr :: fp:ForeignPtr a 
                  -&gt; (PtrN a (fplen fp) -&gt; IO b)  
                  -&gt; IO b             
-}</span>
<span class=hs-linenum> 68: </span>
<span class=hs-linenum> 69: </span><span class='hs-comment'>-- | Pointer Arithmetic</span>
<span class=hs-linenum> 70: </span>
<span class=hs-linenum> 71: </span><span class='hs-comment'>{- plusPtr :: p:Ptr a
           -&gt; o:{Nat|o &lt;= plen p}   -- in bounds
           -&gt; PtrN b (plen b - o)   -- remainder
-}</span>
<span class=hs-linenum> 75: </span>
<span class=hs-linenum> 76: </span><span class='hs-comment'>-- | Read and Write</span>
<span class=hs-linenum> 77: </span>
<span class=hs-linenum> 78: </span><span class='hs-comment'>{- peek :: {v:Ptr a | 0 &lt; plen v} -&gt; IO a  
   poke :: {v:Ptr a | 0 &lt; plen v} -&gt; a -&gt; IO ()  
 -}</span>
<span class=hs-linenum> 81: </span>
<span class=hs-linenum> 82: </span><span class='hs-comment'>-- | Example: Preventing Overflows e.g. writing 5 or 50 zeros?</span>
<span class=hs-linenum> 83: </span>
<span class=hs-linenum> 84: </span><span class='hs-definition'>zero4'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-num'>4</span>
<span class=hs-linenum> 85: </span>            <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum> 86: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 87: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 88: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 89: </span>              <span class='hs-varid'>poke</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class=hs-error><span class='hs-num'>5</span></span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span> 
<span class=hs-linenum> 90: </span>            <span class='hs-varid'>return</span> <span class='hs-varid'>fp</span>
<span class=hs-linenum> 91: </span>        <span class='hs-keyword'>where</span>
<span class=hs-linenum> 92: </span>            <span class='hs-varid'>zero</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum> 93: </span>
<span class=hs-linenum> 94: </span>
<span class=hs-linenum> 95: </span>
<span class=hs-linenum> 96: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 97: </span><span class='hs-comment'>-- | 2. ByteString API -------------------------------------------------</span>
<span class=hs-linenum> 98: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum> 99: </span>
<span class=hs-linenum>100: </span><span class='hs-keyword'>data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-layout'>{</span>
<span class=hs-linenum>101: </span>    <span class='hs-varid'>bPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>102: </span>  <span class='hs-layout'>,</span> <span class='hs-varid'>bOff</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<span class=hs-linenum>103: </span>  <span class='hs-layout'>,</span> <span class='hs-varid'>bLen</span> <span class='hs-keyglyph'>::</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<span class=hs-linenum>104: </span>  <span class='hs-layout'>}</span>
<span class=hs-linenum>105: </span>
<span class=hs-linenum>106: </span>
<span class=hs-linenum>107: </span><span class='hs-comment'>-- | Refined Type, with invariants</span>
<span class=hs-linenum>108: </span>
<span class=hs-linenum>109: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>data</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-layout'>{</span>
<span class=hs-linenum>110: </span>      <span class='hs-varid'>bPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>111: </span>    <span class='hs-layout'>,</span> <span class='hs-varid'>bOff</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span>        <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>bPtr</span><span class='hs-layout'>}</span>
<span class=hs-linenum>112: </span>    <span class='hs-layout'>,</span> <span class='hs-varid'>bLen</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span><span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bOff</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>bPtr</span><span class='hs-layout'>}</span>
<span class=hs-linenum>113: </span>    <span class='hs-layout'>}</span>
<span class=hs-linenum>114: </span>
<span class=hs-linenum>115: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>116: </span>
<span class=hs-linenum>117: </span><span class='hs-comment'>-- | Some useful abbreviations</span>
<span class=hs-linenum>118: </span>
<span class=hs-linenum>119: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringN</span> <span class='hs-conid'>N</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>120: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>StringN</span> <span class='hs-conid'>N</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>String</span>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>N</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>121: </span>
<span class=hs-linenum>122: </span><span class='hs-comment'>-- | Legal Bytestrings </span>
<span class=hs-linenum>123: </span>
<span class=hs-linenum>124: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>good1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-num'>5</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>125: </span><span class='hs-definition'>good1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-num'>5</span>
<span class=hs-linenum>126: </span>           <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>0</span> <span class='hs-num'>5</span>
<span class=hs-linenum>127: </span>
<span class=hs-linenum>128: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>good2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>129: </span><span class='hs-definition'>good2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-num'>5</span>
<span class=hs-linenum>130: </span>           <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>2</span> <span class='hs-num'>3</span>
<span class=hs-linenum>131: </span>
<span class=hs-linenum>132: </span><span class='hs-comment'>-- | Illegal Bytestrings </span>
<span class=hs-linenum>133: </span>
<span class=hs-linenum>134: </span><span class='hs-definition'>bad1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-num'>3</span> 
<span class=hs-linenum>135: </span>          <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>0</span> <span class=hs-error><span class='hs-num'>10</span></span> 
<span class=hs-linenum>136: </span>
<span class=hs-linenum>137: </span><span class='hs-definition'>bad2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class='hs-num'>3</span>
<span class=hs-linenum>138: </span>          <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class='hs-num'>2</span> <span class=hs-error><span class='hs-num'>2</span></span>
<span class=hs-linenum>139: </span>
<span class=hs-linenum>140: </span>
<span class=hs-linenum>141: </span>
<span class=hs-linenum>142: </span><span class='hs-comment'>-- | ByteString API: `create`</span>
<span class=hs-linenum>143: </span>
<span class=hs-linenum>144: </span><span class='hs-definition'>create</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>145: </span>
<span class=hs-linenum>146: </span><span class='hs-definition'>create</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fill</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>147: </span>  <span class='hs-varid'>fp</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mallocForeignPtrBytes</span> <span class=hs-error><span class='hs-varid'>n</span></span>
<span class=hs-linenum>148: </span>  <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fill</span> 
<span class=hs-linenum>149: </span>  <span class='hs-varid'>return</span> <span class='hs-varop'>$!</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>fp</span> <span class=hs-error><span class='hs-num'>0</span></span> <span class=hs-error><span class='hs-varid'>n</span></span>
<span class=hs-linenum>150: </span>
<span class=hs-linenum>151: </span>
<span class=hs-linenum>152: </span><span class='hs-comment'>-- Yikes, there is an error! How to fix?</span>
<span class=hs-linenum>153: </span>
<span class=hs-linenum>154: </span><span class='hs-comment'>-- | ByteStringN API: `unsafeTake`</span>
<span class=hs-linenum>155: </span>
<span class=hs-linenum>156: </span><span class='hs-definition'>unsafeTake</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class=hs-error><span class='hs-varid'>n</span></span>
<span class=hs-linenum>157: </span>
<span class=hs-linenum>158: </span><span class='hs-comment'>-- Wow, thats super fast. O(1)! But how to fix the error?</span>
<span class=hs-linenum>159: </span>
<span class=hs-linenum>160: </span><span class='hs-comment'>-- | ByteString API: `pack`</span>
<span class=hs-linenum>161: </span>
<span class=hs-linenum>162: </span><span class='hs-definition'>pack</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>163: </span><span class='hs-definition'>pack</span> <span class='hs-varid'>str</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>create</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>xs</span>
<span class=hs-linenum>164: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>165: </span>  <span class='hs-varid'>n</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>str</span>
<span class=hs-linenum>166: </span>  <span class='hs-varid'>xs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>c2w</span> <span class='hs-varid'>str</span>
<span class=hs-linenum>167: </span>  <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>poke</span> <span class=hs-error><span class='hs-varid'>p</span></span> <span class='hs-varid'>x</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>plusPtr</span> <span class=hs-error><span class='hs-varid'>p</span></span> <span class=hs-error><span class='hs-num'>1</span></span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<span class=hs-linenum>168: </span>  <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span>  <span class='hs-conid'>()</span>
<span class=hs-linenum>169: </span>
<span class=hs-linenum>170: </span><span class='hs-comment'>-- Hmm. How to fix the error?</span>
<span class=hs-linenum>171: </span>
<span class=hs-linenum>172: </span>
<span class=hs-linenum>173: </span>
<span class=hs-linenum>174: </span><span class='hs-comment'>-- | ByteString API: `unpack` </span>
<span class=hs-linenum>175: </span>
<span class=hs-linenum>176: </span>
<span class=hs-linenum>177: </span>
<span class=hs-linenum>178: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>Unpack</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-varid'>int</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>len</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>len</span> <span class='hs-varid'>acc</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>179: </span>
<span class=hs-linenum>180: </span><span class='hs-definition'>unpack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> 
<span class=hs-linenum>181: </span><span class='hs-definition'>unpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<span class=hs-linenum>182: </span><span class='hs-definition'>unpack</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>ps</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>183: </span>   <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>  <span class='hs-conid'>[]</span>
<span class=hs-linenum>184: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>185: </span>   <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-num'>0</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>peek</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2c</span> <span class='hs-varid'>e</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<span class=hs-linenum>186: </span>   <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>n</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>peek</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>w2c</span> <span class='hs-varid'>e</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<span class=hs-linenum>187: </span>
<span class=hs-linenum>188: </span>
<span class=hs-linenum>189: </span>
<span class=hs-linenum>190: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>191: </span><span class='hs-comment'>-- | 3. Application API (Heartbleed no more!) --------------------------</span>
<span class=hs-linenum>192: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>193: </span>
<span class=hs-linenum>194: </span><span class='hs-definition'>chop</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> 
<span class=hs-linenum>195: </span><span class='hs-definition'>chop</span> <span class='hs-varid'>s</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>s'</span>
<span class=hs-linenum>196: </span>  <span class='hs-keyword'>where</span> 
<span class=hs-linenum>197: </span>    <span class='hs-varid'>b</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pack</span> <span class='hs-varid'>s</span>          <span class='hs-comment'>-- down to low-level</span>
<span class=hs-linenum>198: </span>    <span class='hs-varid'>b'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeTake</span> <span class='hs-varid'>n</span> <span class='hs-varid'>b</span>  <span class='hs-comment'>-- grab n chars</span>
<span class=hs-linenum>199: </span>    <span class='hs-varid'>s'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unpack</span> <span class='hs-varid'>b'</span>       <span class='hs-comment'>-- up to high-level</span>
<span class=hs-linenum>200: </span>
<span class=hs-linenum>201: </span><span class='hs-comment'>-- Whats the problem?</span>
<span class=hs-linenum>202: </span>
<span class=hs-linenum>203: </span>
<span class=hs-linenum>204: </span>
<span class=hs-linenum>205: </span>
<span class=hs-linenum>206: </span>
<span class=hs-linenum>207: </span><span class='hs-comment'>-- | "HeartBleed" no more</span>
<span class=hs-linenum>208: </span>
<span class=hs-linenum>209: </span><span class='hs-definition'>demo</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ex6</span><span class='hs-layout'>,</span> <span class='hs-varid'>ex30</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>210: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>211: </span>    <span class='hs-varid'>ex</span>   <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'R'</span><span class='hs-layout'>,</span><span class='hs-chr'>'a'</span><span class='hs-layout'>,</span><span class='hs-chr'>'n'</span><span class='hs-layout'>,</span><span class='hs-chr'>'j'</span><span class='hs-layout'>,</span><span class='hs-chr'>'i'</span><span class='hs-layout'>,</span><span class='hs-chr'>'t'</span><span class='hs-keyglyph'>]</span>
<span class=hs-linenum>212: </span>    <span class='hs-varid'>ex6</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chop</span> <span class='hs-varid'>ex</span> <span class='hs-num'>6</span>  <span class='hs-comment'>-- ok</span>
<span class=hs-linenum>213: </span>    <span class='hs-varid'>ex30</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chop</span> <span class='hs-varid'>ex</span> <span class='hs-num'>30</span> <span class='hs-comment'>-- out of bounds</span>
<span class=hs-linenum>214: </span>
<span class=hs-linenum>215: </span>
<span class=hs-linenum>216: </span><span class='hs-comment'>-- "Bleeding" `chop ex 30` *rejected* by compiler</span>
<span class=hs-linenum>217: </span>
<span class=hs-linenum>218: </span>
<span class=hs-linenum>219: </span>
<span class=hs-linenum>220: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>221: </span><span class='hs-comment'>-- | 3. Bonus Material -------------------------------------------------</span>
<span class=hs-linenum>222: </span><span class='hs-comment'>------------------------------------------------------------------------</span>
<span class=hs-linenum>223: </span>
<span class=hs-linenum>224: </span><span class='hs-comment'>-- | `group` ing ByteStrings </span>
<span class=hs-linenum>225: </span>
<span class=hs-linenum>226: </span><span class='hs-comment'>{- How shall we type `group` where

     group "foobaaar"

   returns

     ["f","oo", "b", "aaa", "r"]

-}</span>
<span class=hs-linenum>235: </span>
<span class=hs-linenum>236: </span><span class='hs-comment'>-- | An alias for NON-EMPTY ByteStrings</span>
<span class=hs-linenum>237: </span>    
<span class=hs-linenum>238: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringNE</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>{</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>239: </span>
<span class=hs-linenum>240: </span><span class='hs-comment'>-- | A measure for the sum of sizes of a LIST of ByteStrings</span>
<span class=hs-linenum>241: </span>    
<span class=hs-linenum>242: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>measure</span> <span class='hs-varid'>bLens</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<span class=hs-linenum>243: </span>    <span class='hs-varid'>bLens</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<span class=hs-linenum>244: </span>    <span class='hs-varid'>bLens</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>bLen</span> <span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bLens</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<span class=hs-linenum>245: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>246: </span>
<span class=hs-linenum>247: </span><span class='hs-comment'>-- | @group@</span>
<span class=hs-linenum>248: </span>    
<span class=hs-linenum>249: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>group</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteStringNE</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>| bLens v = bLen b}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>250: </span><span class='hs-definition'>group</span> <span class='hs-varid'>xs</span>
<span class=hs-linenum>251: </span>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>xs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<span class=hs-linenum>252: </span>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeHead</span> <span class='hs-varid'>xs</span>
<span class=hs-linenum>253: </span>                      <span class='hs-layout'>(</span><span class='hs-varid'>ys</span><span class='hs-layout'>,</span> <span class='hs-varid'>zs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spanByte</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeHead</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeTail</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<span class=hs-linenum>254: </span>                  <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span> <span class='hs-varop'>`cons`</span> <span class='hs-varid'>ys</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>group</span> <span class='hs-varid'>zs</span>
<span class=hs-linenum>255: </span>
<span class=hs-linenum>256: </span>
<span class=hs-linenum>257: </span><span class='hs-comment'>-- | @spanByte@ does the heavy lifting</span>
<span class=hs-linenum>258: </span>
<span class=hs-linenum>259: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>spanByte</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringPair</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>260: </span><span class='hs-definition'>spanByte</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span>
<span class=hs-linenum>261: </span><span class='hs-definition'>spanByte</span> <span class='hs-varid'>c</span> <span class='hs-varid'>ps</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>x</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>262: </span>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span>
<span class=hs-linenum>263: </span>  <span class='hs-keyword'>where</span>
<span class=hs-linenum>264: </span>    <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>l</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<span class=hs-linenum>265: </span>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>c'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>peekByteOff</span> <span class='hs-varid'>p</span> <span class='hs-varid'>i</span>
<span class=hs-linenum>266: </span>                            <span class='hs-keyword'>if</span> <span class='hs-varid'>c</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>c'</span>
<span class=hs-linenum>267: </span>                                <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeTake</span> <span class='hs-varid'>i</span> <span class='hs-varid'>ps</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsafeDrop</span> <span class='hs-varid'>i</span> <span class='hs-varid'>ps</span><span class='hs-layout'>)</span>
<span class=hs-linenum>268: </span>                                <span class='hs-keyword'>else</span> <span class='hs-varid'>go</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<span class=hs-linenum>269: </span>
<span class=hs-linenum>270: </span><span class='hs-comment'>-- | Using the alias</span>
<span class=hs-linenum>271: </span>                            
<span class=hs-linenum>272: </span><span class='hs-keyword'>{-@</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>ByteStringPair</span> <span class='hs-conid'>B</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span><span class='hs-varop'>&lt;</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x1</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>-&gt;</span>
<span class=hs-linenum>273: </span>       <span class='hs-varid'>bLen</span> <span class='hs-varid'>x1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bLen</span> <span class='hs-varid'>x2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bLen</span> <span class='hs-conid'>B</span><span class='hs-layout'>}</span><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>274: </span>
<span class=hs-linenum>275: </span>
<span class=hs-linenum>276: </span>
<span class=hs-linenum>277: </span>
<span class=hs-linenum>278: </span>
<span class=hs-linenum>279: </span>
<span class=hs-linenum>280: </span>
<span class=hs-linenum>281: </span>
<span class=hs-linenum>282: </span>
<span class=hs-linenum>283: </span>
<span class=hs-linenum>284: </span>
<span class=hs-linenum>285: </span><span class='hs-comment'>----------------------------------------------------------------------------</span>
<span class=hs-linenum>286: </span><span class='hs-comment'>-- | CHEAT AREA</span>
<span class=hs-linenum>287: </span><span class='hs-comment'>----------------------------------------------------------------------------</span>
<span class=hs-linenum>288: </span>
<span class=hs-linenum>289: </span><span class='hs-comment'>-- #START ERRORS 13</span>
<span class=hs-linenum>290: </span><span class='hs-comment'>-- #END   ERRORS 4 (zero4', bad1, bad2, ex30) </span>
<span class=hs-linenum>291: </span>                            
<span class=hs-linenum>292: </span><span class='hs-comment'>{- create     :: n:Nat -&gt; (PtrN Word8 n -&gt; IO ()) -&gt; ByteStringN n      @-}</span>
<span class=hs-linenum>293: </span><span class='hs-comment'>{- unsafeTake :: n:Nat -&gt; b:{ByteString | n &lt;= bLen b} -&gt; ByteStringN n @-}</span>
<span class=hs-linenum>294: </span><span class='hs-comment'>{- pack       :: s:String -&gt; ByteStringN (len s)                        @-}</span>
<span class=hs-linenum>295: </span><span class='hs-comment'>{- unpack     :: b:ByteString -&gt; {v:String | len v = bLen b}            @-}</span>
<span class=hs-linenum>296: </span><span class='hs-comment'>{- chop       :: s:String -&gt; n:{Nat | n &lt;= len s} -&gt; StringN n          @-}</span> 
<span class=hs-linenum>297: </span>
<span class=hs-linenum>298: </span>
<span class=hs-linenum>299: </span>
<span class=hs-linenum>300: </span>
<span class=hs-linenum>301: </span>
<span class=hs-linenum>302: </span>
<span class=hs-linenum>303: </span>
<span class=hs-linenum>304: </span>
<span class=hs-linenum>305: </span>
<span class=hs-linenum>306: </span>
<span class=hs-linenum>307: </span>
<span class=hs-linenum>308: </span>
<span class=hs-linenum>309: </span>
<span class=hs-linenum>310: </span>
<span class=hs-linenum>311: </span>
<span class=hs-linenum>312: </span>
<span class=hs-linenum>313: </span>
<span class=hs-linenum>314: </span>
<span class=hs-linenum>315: </span>
<span class=hs-linenum>316: </span>
<span class=hs-linenum>317: </span>
<span class=hs-linenum>318: </span>
<span class=hs-linenum>319: </span>
<span class=hs-linenum>320: </span>
<span class=hs-linenum>321: </span>
<span class=hs-linenum>322: </span>
<span class=hs-linenum>323: </span>
<span class=hs-linenum>324: </span><span class='hs-comment'>-----------------------------------------------------------------------</span>
<span class=hs-linenum>325: </span><span class='hs-comment'>-- | Helper Code (Stuff from BS benchmark, to make demo self-contained)</span>
<span class=hs-linenum>326: </span><span class='hs-comment'>-----------------------------------------------------------------------</span>
<span class=hs-linenum>327: </span>
<span class=hs-linenum>328: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeCreate</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>l</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrN</span> <span class='hs-conid'>Word8</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteStringN</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>329: </span><span class='hs-definition'>unsafeCreate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class=hs-error><span class='hs-varid'>create</span></span><span class=hs-error> </span><span class=hs-error><span class='hs-varid'>n</span></span><span class=hs-error> </span><span class=hs-error><span class='hs-varid'>f</span></span> <span class='hs-comment'>-- unsafePerformIO $ create n f</span>
<span class=hs-linenum>330: </span>
<span class=hs-linenum>331: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>invariant</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span>   <span class='hs-keyword'>| bLen  v &gt;= 0}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>332: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>invariant</span> <span class='hs-keyword'>{v:</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ByteString</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>| bLens v &gt;= 0}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>333: </span>
<span class=hs-linenum>334: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>PLLen</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>p</span><span class='hs-conop'>:</span><span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>plen</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>335: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>ForeignPtrN</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-varid'>int</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>336: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>FPLenPLen</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>fp</span><span class='hs-conop'>:</span><span class='hs-conid'>ForeignPtr</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>fplen</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>337: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>PtrLen</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>xs</span><span class='hs-conop'>:</span><span class='hs-conid'>List</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>plen</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>len</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>338: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>qualif</span> <span class='hs-conid'>PlenEq</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span> <span class='hs-conid'>Ptr</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span> <span class='hs-varid'>int</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span> <span class='hs-varid'>x</span> <span class='hs-varop'>&lt;=</span> <span class='hs-layout'>(</span><span class='hs-varid'>plen</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>339: </span>
<span class=hs-linenum>340: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) &gt; 0}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>341: </span>
<span class=hs-linenum>342: </span><span class='hs-definition'>unsafeHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>343: </span><span class='hs-definition'>unsafeHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liquidAssert</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<span class=hs-linenum>344: </span>  <span class='hs-varid'>unsafePerformIO</span>  <span class='hs-varop'>$</span>  <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>x</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>peekByteOff</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span>
<span class=hs-linenum>345: </span>
<span class=hs-linenum>346: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeTail</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) &gt; 0}</span>
<span class=hs-linenum>347: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = (bLen b) - 1}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>348: </span><span class='hs-definition'>unsafeTail</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>349: </span><span class='hs-definition'>unsafeTail</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>ps</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liquidAssert</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>ps</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<span class=hs-linenum>350: </span>
<span class=hs-linenum>351: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>null</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>Bool</span> <span class='hs-keyword'>| ((Prop v) &lt;=&gt; ((bLen b) = 0))}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>352: </span><span class='hs-definition'>null</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<span class=hs-linenum>353: </span><span class='hs-definition'>null</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liquidAssert</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>l</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span>
<span class=hs-linenum>354: </span>
<span class=hs-linenum>355: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>unsafeDrop</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-conid'>Nat</span>
<span class=hs-linenum>356: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-keyword'>{v:</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| n &lt;= (bLen v)}</span> 
<span class=hs-linenum>357: </span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = (bLen b) - n}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>358: </span><span class='hs-definition'>unsafeDrop</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>359: </span><span class='hs-definition'>unsafeDrop</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liquidAssert</span> <span class='hs-layout'>(</span><span class='hs-num'>0</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-varop'>+</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-comment'>-</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<span class=hs-linenum>360: </span>
<span class=hs-linenum>361: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>cons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = 1 + (bLen b)}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>362: </span><span class='hs-definition'>cons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>363: </span><span class='hs-definition'>cons</span> <span class='hs-varid'>c</span> <span class='hs-layout'>(</span><span class='hs-conid'>PS</span> <span class='hs-varid'>x</span> <span class='hs-varid'>s</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeCreate</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withForeignPtr</span> <span class='hs-varid'>x</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<span class=hs-linenum>364: </span>        <span class='hs-varid'>poke</span> <span class='hs-varid'>p</span> <span class='hs-varid'>c</span>
<span class=hs-linenum>365: </span>        <span class='hs-varid'>memcpy</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varop'>`plusPtr`</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<span class=hs-linenum>366: </span>
<span class=hs-linenum>367: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>empty</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>| (bLen v) = 0}</span> <span class='hs-keyword'>@-}</span> 
<span class=hs-linenum>368: </span><span class='hs-definition'>empty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span>
<span class=hs-linenum>369: </span><span class='hs-definition'>empty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PS</span> <span class='hs-varid'>nullForeignPtr</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span>
<span class=hs-linenum>370: </span>
<span class=hs-linenum>371: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>assume</span>
<span class=hs-linenum>372: </span>    <span class='hs-varid'>c_memcpy</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>dst</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>373: </span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>src</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span> 
<span class=hs-linenum>374: </span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>size</span><span class='hs-conop'>:</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>CSize</span> <span class='hs-keyword'>| (v &lt;= (plen src) &amp;&amp; v &lt;= (plen dst))}</span> 
<span class=hs-linenum>375: </span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>376: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>377: </span><span class='hs-keyword'>foreign</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>ccall</span> <span class='hs-keyword'>unsafe</span> <span class='hs-str'>"string.h memcpy"</span> <span class='hs-varid'>c_memcpy</span>
<span class=hs-linenum>378: </span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>379: </span>
<span class=hs-linenum>380: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>memcpy</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>dst</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<span class=hs-linenum>381: </span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>src</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>PtrV</span> <span class='hs-conid'>Word8</span><span class='hs-layout'>)</span> 
<span class=hs-linenum>382: </span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>size</span><span class='hs-conop'>:</span> <span class='hs-keyword'>{v:</span><span class='hs-conid'>CSize</span> <span class='hs-keyword'>| (v &lt;= (plen src) &amp;&amp; v &lt;= (plen dst))}</span> 
<span class=hs-linenum>383: </span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> 
<span class=hs-linenum>384: </span>  <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>385: </span><span class='hs-definition'>memcpy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ptr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CSize</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<span class=hs-linenum>386: </span><span class='hs-definition'>memcpy</span> <span class='hs-varid'>p</span> <span class='hs-varid'>q</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c_memcpy</span> <span class='hs-varid'>p</span> <span class='hs-varid'>q</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<span class=hs-linenum>387: </span>
<span class=hs-linenum>388: </span><span class='hs-keyword'>{-@</span> <span class='hs-varid'>assume</span> <span class='hs-varid'>nullForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>{v:</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span> <span class='hs-keyword'>| (fplen v) = 0}</span> <span class='hs-keyword'>@-}</span>
<span class=hs-linenum>389: </span><span class='hs-definition'>nullForeignPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ForeignPtr</span> <span class='hs-conid'>Word8</span>
<span class=hs-linenum>390: </span><span class='hs-definition'>nullForeignPtr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newForeignPtr_</span> <span class='hs-varid'>nullPtr</span>
<span class=hs-linenum>391: </span><span class='hs-comment'>{-# NOINLINE nullForeignPtr #-}</span>
<span class=hs-linenum>392: </span>
</pre>
<head>
<link type='text/css' rel='stylesheet' href='liquid.css' />
</head>
